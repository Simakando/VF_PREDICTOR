<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BetPawa Predictor Ultra v3.0</title>
<style>
  /* [All the CSS from your original file goes here - exactly as provided] */
  @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600;700;900&display=swap');

  :root {
    --primary: #1a472a; --primary-light: #00c851;
    --secondary: #07071a; --accent: #ff6b35;
    --gold: #ffd700; --gold2: #ffaa00;
    --danger: #ff3547; --bg: #050510;
    --card: #0d0d20; --card2: #13132a; --card3: #18183a;
    --text: #e8e8f5; --text2: #7878a0;
    --border: #22224a; --green: #00c851; --red: #ff3547;
    --blue: #4a9eff; --orange: #ff9800; --purple: #a855f7;
    --trap: #ff3547; --variance: #ff9800; --underdog: #a855f7;
    --acca: #ffd700; --ml: #00bcd4;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; font-size: 13px; min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(ellipse at 20% 0%, rgba(0,200,81,0.07) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(255,215,0,0.05) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  /* HEADER */
  .header { background: linear-gradient(135deg, #0f0f2a 0%, #07071a 100%); border-bottom: 2px solid rgba(255,215,0,0.4); padding: 10px 15px; text-align: center; position: sticky; top: 0; z-index: 1000; }
  .header-title { font-family: 'Rajdhani', sans-serif; font-size: 18px; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: 3px; }
  .header-sub { font-size: 9px; color: var(--text2); margin-top: 2px; }
  .accuracy-badge { display: inline-block; background: linear-gradient(135deg, var(--green), #007a30); color: #000; padding: 3px 12px; border-radius: 20px; font-size: 9px; font-weight: 700; margin-top: 5px; animation: pulse 2s infinite; }
  .version-badge { display: inline-block; background: linear-gradient(135deg, var(--purple), #6a0dad); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 8px; font-weight: 700; margin-left: 5px; }
  @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }

  /* DATA QUALITY BAR */
  .data-quality-bar { background: linear-gradient(90deg, #0a0a1f, #0f102a, #0a0a1f); border-bottom: 1px solid var(--purple); padding: 5px 12px; display: flex; align-items: center; justify-content: space-between; font-size: 9px; gap: 6px; flex-wrap: wrap; }
  .dq-item { display: flex; align-items: center; gap: 4px; }
  .dq-dot { width: 6px; height: 6px; border-radius: 50%; }
  .dq-dot.real { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dq-dot.static { background: var(--orange); }
  .dq-dot.loading { background: var(--blue); animation: blink 0.8s infinite; }
  .dq-label { color: var(--text2); } .dq-value { color: var(--text); font-weight: 700; } .dq-matches { color: var(--purple); font-weight: 700; }

  /* LIVE STATUS BAR */
  .live-status-bar { background: linear-gradient(90deg, #060f06, #0a1a0a, #060f06); border-bottom: 1px solid rgba(0,200,81,0.3); padding: 7px 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
  .live-indicator { display: flex; align-items: center; gap: 5px; font-size: 10px; font-weight: 700; }
  .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: blink 1s infinite; }
  .live-dot.offline { background: var(--red); animation: none; }
  .live-dot.loading { background: var(--blue); animation: blink 0.5s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }
  .season-info { font-size: 11px; font-weight: 700; color: var(--gold); }
  .matchday-info { font-size: 11px; color: var(--text2); }
  .countdown-box { background: rgba(255,215,0,0.12); border: 1px solid rgba(255,215,0,0.4); border-radius: 6px; padding: 4px 10px; font-size: 12px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; min-width: 75px; text-align: center; }
  .refresh-btn { background: rgba(0,200,81,0.1); border: 1px solid var(--green); border-radius: 5px; color: var(--green); font-size: 9px; font-weight: 700; padding: 4px 9px; cursor: pointer; transition: all 0.2s; }
  .refresh-btn:hover { background: var(--green); color: #000; }

  /* LEAGUE SELECTOR */
  .league-selector { display: flex; gap: 5px; padding: 8px 10px; overflow-x: auto; background: var(--card); border-bottom: 1px solid var(--border); scrollbar-width: none; }
  .league-selector::-webkit-scrollbar { display: none; }
  .league-btn { flex: 0 0 auto; padding: 5px 12px; background: var(--card2); border: 1px solid var(--border); border-radius: 20px; color: var(--text2); font-size: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
  .league-btn.active, .league-btn:hover { background: rgba(0,200,81,0.15); border-color: var(--primary-light); color: var(--gold); }

  /* TABS */
  .tabs { display: flex; background: var(--secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; overflow-x: auto; scrollbar-width: none; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab { flex: 0 0 auto; padding: 9px 8px; font-size: 9px; font-weight: 700; cursor: pointer; color: var(--text2); border-bottom: 2px solid transparent; margin-bottom: -1px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; white-space: nowrap; }
  .tab.active { color: var(--primary-light); border-bottom-color: var(--primary-light); background: rgba(0,200,81,0.07); }

  /* SECTIONS */
  .section { display: none; padding: 10px; padding-bottom: 90px; }
  .section.active { display: block; }

  /* LIVE PREDICTIONS */
  .live-predictions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 10px; background: linear-gradient(135deg, rgba(255,215,0,0.08), rgba(0,200,81,0.04)); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; }
  .live-pred-title { font-size: 11px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
  .high-conf-badge { background: var(--green); color: #000; font-size: 9px; font-weight: 900; padding: 3px 8px; border-radius: 10px; }

  /* PREDICTION CARDS */
  .pred-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 8px; position: relative; overflow: hidden; }
  .pred-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--green), transparent); }
  .pred-card.ultra-conf::before { background: linear-gradient(90deg, transparent, var(--gold), transparent); }
  .pred-card.high-conf { border-color: rgba(0,200,81,0.4); background: linear-gradient(135deg, rgba(0,200,81,0.05), rgba(0,0,0,0)); }
  .pred-card.ultra-conf { border-color: rgba(255,215,0,0.5); background: linear-gradient(135deg, rgba(255,215,0,0.06), rgba(0,0,0,0)); box-shadow: 0 0 20px rgba(255,215,0,0.1); }
  .pred-card.trap-warned { border-color: rgba(255,53,71,0.5) !important; }
  .pred-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .pred-match-name { font-size: 15px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .pred-league-tag { font-size: 9px; color: var(--text2); background: var(--card2); padding: 2px 6px; border-radius: 4px; margin-top: 3px; display: inline-block; }
  .pred-conf-badge { font-size: 14px; font-weight: 900; padding: 4px 10px; border-radius: 10px; font-family: 'Rajdhani', sans-serif; }
  .conf-ultra { background: rgba(255,215,0,0.15); color: var(--gold); border: 1px solid rgba(255,215,0,0.3); }
  .conf-high { background: rgba(0,200,81,0.15); color: var(--green); border: 1px solid rgba(0,200,81,0.3); }
  .pred-main-bet { background: linear-gradient(135deg, rgba(0,200,81,0.1), rgba(0,100,40,0.05)); border: 1px solid rgba(0,200,81,0.3); border-radius: 8px; padding: 8px 12px; text-align: center; margin-bottom: 8px; }
  .pred-bet-label { font-size: 8px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .pred-bet-value { font-size: 17px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }

  /* TRAP PANEL */
  .trap-panel { background: rgba(255,53,71,0.08); border: 1px solid rgba(255,53,71,0.4); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
  .trap-panel-title { font-size: 9px; font-weight: 900; color: var(--red); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
  .trap-item { font-size: 9px; color: #ff8a8a; padding: 2px 0; display: flex; align-items: flex-start; gap: 5px; }
  .trap-icon { min-width: 12px; }
  .trap-level { font-size: 8px; padding: 1px 5px; border-radius: 4px; font-weight: 700; }
  .tl-high { background: rgba(255,53,71,0.3); color: var(--red); }
  .tl-med { background: rgba(255,152,0,0.3); color: var(--orange); }
  .tl-low { background: rgba(255,255,100,0.2); color: #ffff60; }

  /* VARIANCE PANEL */
  .variance-panel { background: rgba(255,152,0,0.08); border: 1px solid rgba(255,152,0,0.4); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
  .variance-title { font-size: 9px; font-weight: 900; color: var(--orange); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
  .variance-item { font-size: 9px; color: #ffcc80; padding: 2px 0; display: flex; align-items: flex-start; gap: 5px; }
  .variance-score-bar { height: 8px; background: var(--card3); border-radius: 4px; overflow: hidden; margin-top: 5px; }
  .variance-score-fill { height: 100%; background: linear-gradient(90deg, var(--orange), var(--red)); border-radius: 4px; }

  /* UNDERDOG PANEL */
  .underdog-panel { background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.4); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
  .underdog-title { font-size: 9px; font-weight: 900; color: var(--purple); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
  .underdog-item { font-size: 9px; color: #d4a4f8; padding: 2px 0; display: flex; align-items: flex-start; gap: 5px; }

  /* DETAILED ANALYSIS */
  .analysis-panel { background: linear-gradient(135deg, rgba(74,158,255,0.06), rgba(0,200,81,0.03)); border: 1px solid rgba(74,158,255,0.3); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
  .analysis-title { font-size: 9px; font-weight: 900; color: var(--blue); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .analysis-row { display: flex; justify-content: space-between; align-items: center; font-size: 9px; padding: 3px 0; border-bottom: 1px solid rgba(34,34,74,0.4); }
  .analysis-row:last-child { border-bottom: none; }
  .analysis-label { color: var(--text2); }
  .analysis-value { font-weight: 700; color: var(--text); }
  .analysis-verdict { background: rgba(0,200,81,0.1); border: 1px solid rgba(0,200,81,0.3); border-radius: 6px; padding: 6px 8px; margin-top: 6px; font-size: 10px; color: var(--green); font-weight: 600; line-height: 1.5; }
  .analysis-verdict.risky { background: rgba(255,152,0,0.1); border-color: rgba(255,152,0,0.3); color: var(--orange); }
  .analysis-verdict.danger { background: rgba(255,53,71,0.1); border-color: rgba(255,53,71,0.3); color: var(--red); }

  /* ACCA BUILDER PANEL */
  .acca-panel { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,152,0,0.05)); border: 2px solid rgba(255,215,0,0.5); border-radius: 12px; padding: 12px; margin: 10px 0; box-shadow: 0 0 20px rgba(255,215,0,0.08); }
  .acca-title { font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 900; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; text-align: center; }
  .acca-subtitle { font-size: 9px; color: var(--text2); text-align: center; margin-bottom: 10px; }
  .acca-legs { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
  .acca-leg { background: var(--card2); border: 1px solid var(--border); border-radius: 7px; padding: 8px; display: flex; justify-content: space-between; align-items: center; }
  .acca-leg.clean { border-color: rgba(0,200,81,0.3); }
  .acca-leg-match { font-size: 12px; font-weight: 700; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .acca-leg-bet { font-size: 10px; color: var(--green); font-weight: 700; }
  .acca-leg-right { text-align: right; }
  .acca-leg-odds { font-size: 14px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .acca-leg-conf { font-size: 8px; color: var(--text2); }
  .acca-totals { background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
  .acca-total-item { }
  .acca-total-label { font-size: 8px; color: var(--text2); text-transform: uppercase; }
  .acca-total-value { font-size: 18px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .acca-protection { font-size: 9px; color: var(--red); margin-top: 8px; text-align: center; }
  .acca-empty { text-align: center; padding: 15px; color: var(--text2); font-size: 10px; }

  /* REAL STATS */
  .real-stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
  .real-stat-box { background: var(--card2); border-radius: 6px; padding: 6px 8px; text-align: center; }
  .real-stat-team { font-size: 10px; font-weight: 700; color: var(--gold); margin-bottom: 4px; }
  .real-stat-grid { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; }
  .stat-pill { font-size: 8px; font-weight: 700; padding: 2px 5px; border-radius: 4px; }
  .sp-over { background: rgba(0,200,81,0.2); color: var(--green); }
  .sp-btts { background: rgba(74,158,255,0.2); color: var(--blue); }
  .sp-form { background: rgba(255,215,0,0.2); color: var(--gold); }
  .form-boxes-row { display: flex; gap: 3px; justify-content: center; margin-top: 4px; }
  .form-box-mini { width: 16px; height: 16px; border-radius: 3px; font-size: 8px; font-weight: 900; display: flex; align-items: center; justify-content: center; }
  .fb-over { background: rgba(0,200,81,0.3); color: var(--green); }
  .fb-under { background: rgba(255,53,71,0.3); color: var(--red); }
  .fb-na { background: rgba(100,100,130,0.3); color: var(--text2); }

  .pred-card-body { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
  .pred-info-item { background: var(--card2); padding: 6px 8px; border-radius: 6px; }
  .pred-info-label { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-bottom: 2px; }
  .pred-info-value { font-size: 10px; font-weight: 700; color: var(--text); }
  .pred-countdown { display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 10px; color: var(--text2); }
  .pred-countdown .time { color: var(--orange); font-weight: 700; font-family: 'Rajdhani', sans-serif; }
  .pred-countdown .time.urgent { color: var(--red); animation: pulse 1s infinite; }

  /* STATS LOADER */
  .stats-loader { background: linear-gradient(135deg, rgba(168,85,247,0.08), rgba(0,200,81,0.04)); border: 1px solid rgba(168,85,247,0.3); border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
  .stats-loader-icon { font-size: 20px; }
  .stats-loader-text { font-size: 10px; color: var(--text2); }
  .stats-loader-title { font-size: 11px; font-weight: 700; color: var(--purple); margin-bottom: 2px; }
  .stats-progress-bar { height: 4px; background: var(--card3); border-radius: 2px; margin-top: 5px; overflow: hidden; }
  .stats-progress-fill { height: 100%; background: linear-gradient(90deg, var(--purple), var(--green)); border-radius: 2px; transition: width 0.5s ease; width: 0%; }

  /* ML DATA TAB */
  .ml-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
  .ml-panel-title { font-family: 'Rajdhani', sans-serif; font-size: 14px; font-weight: 700; color: var(--ml); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
  .ml-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
  .ml-stat { background: var(--card2); border-radius: 8px; padding: 10px; text-align: center; border: 1px solid rgba(0,188,212,0.2); }
  .ml-stat-value { font-size: 24px; font-weight: 900; color: var(--ml); font-family: 'Rajdhani', sans-serif; }
  .ml-stat-label { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-top: 2px; }
  .ml-progress-section { margin-bottom: 12px; }
  .ml-progress-label { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 5px; }
  .ml-progress-bar { height: 20px; background: var(--card2); border-radius: 10px; overflow: hidden; border: 1px solid rgba(0,188,212,0.3); }
  .ml-progress-fill { height: 100%; background: linear-gradient(90deg, var(--ml), var(--purple)); border-radius: 10px; transition: width 1s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 9px; font-weight: 700; color: #000; }
  .download-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--ml), var(--purple)); border: none; border-radius: 8px; color: #000; font-size: 12px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; font-family: 'Rajdhani', sans-serif; transition: all 0.2s; margin-bottom: 8px; }
  .download-btn:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,188,212,0.4); }
  .download-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .clear-ml-btn { width: 100%; padding: 8px; background: rgba(255,53,71,0.1); border: 1px solid var(--red); border-radius: 6px; color: var(--red); font-size: 10px; font-weight: 700; cursor: pointer; }

  /* SELF-LEARNING PANEL */
  .learn-panel { background: linear-gradient(135deg, rgba(0,188,212,0.05), rgba(168,85,247,0.05)); border: 1px solid rgba(0,188,212,0.3); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
  .learn-title { font-size: 12px; font-weight: 700; color: var(--ml); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .learn-cycle { font-size: 10px; color: var(--text2); margin-bottom: 8px; }
  .learn-adjustment { display: flex; justify-content: space-between; align-items: center; background: var(--card2); border-radius: 6px; padding: 6px 10px; margin-bottom: 5px; }
  .learn-adj-name { font-size: 10px; color: var(--text2); }
  .learn-adj-val { font-size: 12px; font-weight: 700; font-family: 'Rajdhani', sans-serif; }
  .learn-log { background: var(--card2); border-radius: 6px; padding: 8px; max-height: 120px; overflow-y: auto; font-size: 8px; color: var(--text2); font-family: monospace; }

  /* EMPTY STATE */
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text2); }
  .empty-icon { font-size: 44px; margin-bottom: 12px; }
  .empty-title { font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 6px; }
  .empty-desc { font-size: 11px; line-height: 1.6; }

  /* MANUAL PREDICTOR */
  .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .team-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 8px; max-height: 38vh; overflow-y: auto; }
  .panel-title { font-size: 9px; font-weight: 800; color: var(--gold); margin-bottom: 6px; text-align: center; text-transform: uppercase; letter-spacing: 1px; position: sticky; top: 0; background: var(--card); padding: 4px 0; z-index: 10; border-bottom: 1px solid var(--border); }
  .team-list { display: flex; flex-direction: column; gap: 2px; }
  .team-item { display: flex; align-items: center; gap: 4px; padding: 5px 6px; background: var(--card2); border: 1px solid transparent; border-radius: 5px; cursor: pointer; transition: all 0.15s; font-size: 10px; }
  .team-item:hover { border-color: var(--primary-light); }
  .team-item.selected-home { border-color: var(--green); background: rgba(0,200,81,0.15); }
  .team-item.selected-away { border-color: var(--blue); background: rgba(74,158,255,0.15); }
  .team-code { font-weight: 900; font-size: 11px; min-width: 28px; font-family: 'Rajdhani', sans-serif; }
  .team-name { flex: 1; color: var(--text2); font-size: 8px; }
  .team-rating { font-size: 7px; padding: 2px 4px; border-radius: 3px; font-weight: 700; }
  .r-activator { background: rgba(255,215,0,0.15); color: var(--gold); }
  .r-strong { background: rgba(0,200,81,0.15); color: var(--green); }
  .r-neutral { background: rgba(136,136,160,0.15); color: var(--text2); }
  .r-weak { background: rgba(255,53,71,0.15); color: var(--red); }
  .team-live-badge { font-size: 7px; color: var(--purple); font-weight: 700; }

  /* PREDICTION ENGINE */
  .prediction-engine { grid-column: 1/-1; background: linear-gradient(135deg, rgba(255,215,0,0.07), rgba(0,200,81,0.03)); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; padding: 12px; margin-top: 8px; }
  .engine-title { font-size: 10px; font-weight: 800; color: var(--gold); margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
  .match-display { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; margin-bottom: 10px; }
  .team-box { background: var(--card2); border: 2px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; min-height: 65px; display: flex; flex-direction: column; justify-content: center; transition: all 0.3s; }
  .team-box.active { border-color: var(--gold); background: rgba(255,215,0,0.08); }
  .team-box-code { font-size: 20px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .team-box-name { font-size: 8px; color: var(--text2); margin-top: 2px; }
  .team-box-stats { font-size: 8px; color: var(--purple); margin-top: 2px; font-weight: 600; }
  .vs-box { font-size: 12px; font-weight: 900; color: var(--text2); font-family: 'Rajdhani', sans-serif; }
  .prediction-result { background: var(--card2); border-radius: 8px; padding: 10px; text-align: center; border: 2px solid transparent; transition: all 0.3s; }
  .prediction-result.high { border-color: var(--green); background: rgba(0,200,81,0.08); }
  .prediction-result.medium { border-color: var(--orange); background: rgba(255,152,0,0.08); }
  .prediction-result.low { border-color: var(--red); background: rgba(255,53,71,0.08); }
  .result-title { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-bottom: 3px; }
  .result-prediction { font-size: 17px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .result-confidence { font-size: 22px; font-weight: 900; font-family: 'Rajdhani', sans-serif; }
  .result-reason { font-size: 8px; color: var(--text2); margin-top: 3px; }
  .add-match-btn { width: 100%; margin-top: 8px; padding: 9px; background: rgba(0,200,81,0.15); border: 1px solid var(--green); border-radius: 7px; color: var(--gold); font-size: 11px; font-weight: 900; cursor: pointer; text-transform: uppercase; transition: all 0.2s; font-family: 'Rajdhani', sans-serif; letter-spacing: 1px; }
  .add-match-btn:hover:not(:disabled) { background: var(--green); color: #000; }
  .add-match-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* MATCH HISTORY */
  .match-history { grid-column: 1/-1; margin-top: 8px; }
  .history-title { font-size: 10px; font-weight: 700; color: var(--primary-light); margin-bottom: 6px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
  .clear-btn { font-size: 9px; padding: 3px 7px; background: rgba(255,53,71,0.2); border: 1px solid var(--red); border-radius: 4px; color: var(--red); cursor: pointer; }
  .history-list { display: flex; flex-direction: column; gap: 5px; }
  .history-item { background: var(--card); border: 1px solid var(--border); border-radius: 7px; padding: 7px 9px; display: grid; grid-template-columns: 22px 1fr 55px 32px; gap: 7px; align-items: center; }
  .history-num { background: rgba(0,200,81,0.15); color: var(--green); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 9px; }
  .history-match { font-weight: 700; font-size: 10px; }
  .history-prediction { text-align: center; }
  .history-stars { color: var(--gold); font-size: 9px; }
  .history-accuracy { font-size: 8px; color: var(--text2); }
  .delete-btn { background: rgba(255,53,71,0.2); color: var(--red); border: none; border-radius: 4px; padding: 3px 6px; cursor: pointer; font-size: 9px; }

  /* STRATEGY */
  .strategy-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-top: 8px; }
  .strategy-title { font-size: 10px; font-weight: 700; color: var(--gold); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
  .strategy-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .strategy-card { background: var(--card2); padding: 7px; border-radius: 6px; border-left: 3px solid var(--primary-light); }
  .strategy-name { font-size: 9px; font-weight: 700; color: var(--primary-light); margin-bottom: 2px; }
  .strategy-desc { font-size: 8px; color: var(--text2); line-height: 1.4; }
  .strategy-card.trap { border-left-color: var(--red); }
  .strategy-card.trap .strategy-name { color: var(--red); }
  .strategy-card.underdog { border-left-color: var(--purple); }
  .strategy-card.underdog .strategy-name { color: var(--purple); }
  .strategy-card.variance { border-left-color: var(--orange); }
  .strategy-card.variance .strategy-name { color: var(--orange); }

  /* STATS PANEL */
  .stats-panel { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
  .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; }
  .stat-item { background: var(--card2); padding: 8px; border-radius: 6px; }
  .stat-value { font-size: 20px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .stat-label { font-size: 8px; color: var(--text2); text-transform: uppercase; margin-top: 2px; }

  /* ALERTS */
  .alert { background: rgba(255,53,71,0.1); border: 1px solid var(--red); border-radius: 7px; padding: 8px 10px; margin: 6px 0; font-size: 10px; color: var(--red); }
  .alert-warning { background: rgba(255,152,0,0.1); border-color: var(--orange); color: var(--orange); }
  .alert-success { background: rgba(0,200,81,0.1); border-color: var(--green); color: var(--green); }
  .alert-info { background: rgba(74,158,255,0.1); border-color: var(--blue); color: var(--blue); }
  .alert-purple { background: rgba(168,85,247,0.1); border-color: var(--purple); color: var(--purple); }
  .alert-ml { background: rgba(0,188,212,0.1); border-color: var(--ml); color: var(--ml); }

  /* POWER METER */
  .power-meter { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
  .meter-title { font-size: 10px; font-weight: 700; color: var(--gold); margin-bottom: 7px; text-transform: uppercase; display: flex; justify-content: space-between; }
  .meter-bar { height: 22px; background: var(--card2); border-radius: 11px; overflow: hidden; border: 1px solid var(--border); }
  .meter-fill { height: 100%; background: linear-gradient(90deg, var(--red) 0%, var(--orange) 50%, var(--green) 100%); border-radius: 11px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 7px; font-weight: 900; font-size: 10px; color: #000; font-family: 'Rajdhani', sans-serif; }
  .meter-labels { display: flex; justify-content: space-between; margin-top: 3px; font-size: 8px; color: var(--text2); }

  /* BOTTOM NAV */
  .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--secondary); border-top: 1px solid var(--border); display: flex; z-index: 1000; padding-bottom: env(safe-area-inset-bottom,0); overflow-x: auto; }
  .bottom-nav-item { flex: 0 0 auto; min-width: 60px; display: flex; flex-direction: column; align-items: center; padding: 7px 4px; cursor: pointer; color: var(--text2); font-size: 7px; transition: all 0.2s; gap: 2px; }
  .bottom-nav-item .nav-icon { font-size: 16px; }
  .bottom-nav-item.active { color: var(--primary-light); background: rgba(0,200,81,0.08); }
  .badge-count { background: var(--red); color: white; font-size: 8px; font-weight: 900; padding: 1px 4px; border-radius: 7px; min-width: 14px; text-align: center; display: none; }
  .badge-count.show { display: inline-block; }

  /* NOTIFICATION OVERLAY */
  .notification-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px; }
  .notification-overlay.show { display: flex; }
  .notification-card { background: linear-gradient(135deg, #0a1a0a, #151f15); border: 2px solid var(--gold); border-radius: 14px; padding: 20px; max-width: 380px; width: 100%; text-align: center; box-shadow: 0 0 40px rgba(255,215,0,0.2); }
  .notif-title { font-size: 16px; font-weight: 900; color: var(--gold); margin-bottom: 6px; text-transform: uppercase; font-family: 'Rajdhani', sans-serif; letter-spacing: 2px; }
  .notif-season { font-size: 11px; color: var(--text2); margin-bottom: 3px; }
  .notif-matchday { font-size: 13px; font-weight: 700; color: var(--green); margin-bottom: 14px; }
  .notif-matches { display: flex; flex-direction: column; gap: 7px; margin-bottom: 14px; }
  .notif-match-item { background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 7px; padding: 9px; }
  .notif-match-name { font-size: 14px; font-weight: 900; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .notif-match-bet { font-size: 11px; color: var(--green); font-weight: 700; margin-top: 2px; }
  .notif-match-conf { font-size: 10px; color: var(--text2); }
  .notif-countdown { font-size: 13px; color: var(--orange); font-weight: 700; margin-bottom: 14px; font-family: 'Rajdhani', sans-serif; }
  .notif-close-btn { background: rgba(0,200,81,0.15); border: 1px solid var(--green); color: var(--gold); font-size: 13px; font-weight: 700; padding: 10px 24px; border-radius: 7px; cursor: pointer; width: 100%; font-family: 'Rajdhani', sans-serif; transition: all 0.2s; }
  .notif-close-btn:hover { background: var(--green); color: #000; }

  /* TEAM STATS TABLE */
  .team-stats-table { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; margin-top: 8px; overflow-x: auto; }
  .table-title { font-size: 10px; font-weight: 700; color: var(--purple); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
  table { width: 100%; border-collapse: collapse; font-size: 10px; }
  th { color: var(--text2); font-size: 8px; text-transform: uppercase; padding: 4px 6px; text-align: center; border-bottom: 1px solid var(--border); }
  td { padding: 5px 6px; text-align: center; border-bottom: 1px solid rgba(34,34,74,0.5); }
  tr:hover td { background: rgba(255,255,255,0.02); }
  .td-team { text-align: left; font-weight: 700; color: var(--gold); font-family: 'Rajdhani', sans-serif; }
  .td-good { color: var(--green); font-weight: 700; }
  .td-bad { color: var(--red); font-weight: 700; }
  .td-mid { color: var(--orange); font-weight: 700; }
  .source-tag { font-size: 7px; font-weight: 600; padding: 1px 4px; border-radius: 3px; }
  .st-real { background: rgba(168,85,247,0.2); color: var(--purple); }
  .st-static { background: rgba(255,152,0,0.2); color: var(--orange); }

  /* LOADING SPINNER */
  .loading-spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 4px; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* RNG CYCLE INDICATOR */
  .rng-cycle-box { background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.3); border-radius: 8px; padding: 8px 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .rng-cycle-icon { font-size: 18px; }
  .rng-cycle-text { flex: 1; }
  .rng-cycle-label { font-size: 9px; font-weight: 700; color: var(--purple); }
  .rng-cycle-desc { font-size: 8px; color: var(--text2); margin-top: 2px; }

  /* RATING CALC */
  .rating-calc { grid-column: 1/-1; background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-top: 8px; }
  .calc-title { font-size: 9px; font-weight: 700; color: var(--primary-light); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
  .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
  .calc-item { background: var(--card2); padding: 6px; border-radius: 5px; text-align: center; }
  .calc-label { font-size: 8px; color: var(--text2); text-transform: uppercase; }
  .calc-value { font-size: 13px; font-weight: 900; color: var(--gold); margin-top: 1px; font-family: 'Rajdhani', sans-serif; }
  .calc-formula { grid-column: 1/-1; background: rgba(255,215,0,0.07); padding: 6px; border-radius: 5px; font-size: 8px; color: var(--gold); text-align: center; margin-top: 4px; }
</style>
</head>
<body>

<!-- NOTIFICATION OVERLAY -->
<div class="notification-overlay" id="notifOverlay">
  <div class="notification-card">
    <div class="notif-title">üéØ HIGH CONFIDENCE PICKS</div>
    <div class="notif-season" id="notifSeason">Season --</div>
    <div class="notif-matchday" id="notifMatchday">Loading...</div>
    <div class="notif-matches" id="notifMatches"></div>
    <div class="notif-countdown" id="notifCountdown">‚è± Calculating...</div>
    <button class="notif-close-btn" onclick="closeNotification()">‚úì GOT IT ‚Äî PLACE BETS</button>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-title">‚ö° BetPawa Predictor <span class="version-badge">ULTRA v3.0</span></div>
  <div class="header-sub">Live ‚Ä¢ Trap Detection ‚Ä¢ Self-Learning AI ‚Ä¢ ML Collector</div>
  <div class="accuracy-badge">üéØ Real Data | Trap Shield | Auto-Learning</div>
</div>

<!-- DATA QUALITY BAR -->
<div class="data-quality-bar">
  <div class="dq-item">
    <div class="dq-dot loading" id="dqDot"></div>
    <span class="dq-label">Engine:</span>
    <span class="dq-value" id="dqStatus">Starting...</span>
  </div>
  <div class="dq-item"><span class="dq-label">Matches:</span><span class="dq-matches" id="dqMatches">0</span></div>
  <div class="dq-item"><span class="dq-label">Teams:</span><span class="dq-value" id="dqTeams">0</span></div>
  <div class="dq-item"><span class="dq-label">ML Records:</span><span class="dq-value" id="dqML">0</span></div>
  <div class="dq-item"><span class="dq-label">Learned:</span><span class="dq-value" id="dqLearned">0 cycles</span></div>
</div>

<!-- LIVE STATUS BAR -->
<div class="live-status-bar">
  <div class="live-indicator">
    <div class="live-dot" id="liveDot"></div>
    <span id="liveStatus">Connecting...</span>
  </div>
  <div class="season-info" id="seasonDisplay">Season --</div>
  <div class="matchday-info" id="matchdayDisplay">MD --</div>
  <div class="countdown-box" id="countdownDisplay">--:--</div>
  <button class="refresh-btn" id="refreshBtn" onclick="fetchLiveData()">üîÑ Refresh</button>
</div>

<!-- LEAGUE SELECTOR -->
<div class="league-selector">
  <button class="league-btn active" onclick="switchLeague('england', this)">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø England</button>
  <button class="league-btn" onclick="switchLeague('germany', this)">üá©üá™ Germany</button>
  <button class="league-btn" onclick="switchLeague('italy', this)">üáÆüáπ Italy</button>
  <button class="league-btn" onclick="switchLeague('spain', this)">üá™üá∏ Spain</button>
  <button class="league-btn" onclick="switchLeague('france', this)">üá´üá∑ France</button>
  <button class="league-btn" onclick="switchLeague('portugal', this)">üáµüáπ Portugal</button>
  <button class="league-btn" onclick="switchLeague('netherlands', this)">üá≥üá± Netherlands</button>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="showTab('live')" id="tab-btn-live">üî¥ Live <span class="badge-count" id="liveBadge">0</span></div>
  <div class="tab" onclick="showTab('predictor')" id="tab-btn-predictor">üéØ Predict</div>
  <div class="tab" onclick="showTab('teamstats')" id="tab-btn-teamstats">üìä Stats</div>
  <div class="tab" onclick="showTab('analyzer')" id="tab-btn-analyzer">üìà Analyze</div>
  <div class="tab" onclick="showTab('mldata')" id="tab-btn-mldata">üß† ML Data</div>
  <div class="tab" onclick="showTab('strategies')" id="tab-btn-strategies">üìö Tips</div>
</div>

<div class="main-content">

<!-- ==================== LIVE TAB ==================== -->
<div class="section active" id="tab-live">
  <div id="statsLoaderDisplay" class="stats-loader">
    <div class="stats-loader-icon">üß†</div>
    <div style="flex:1">
      <div class="stats-loader-title">Dynamic Stats Engine + Self-Learner Initializing...</div>
      <div class="stats-loader-text" id="statsLoaderText">Loading real BetPawa historical data & applying learned adjustments...</div>
      <div class="stats-progress-bar"><div class="stats-progress-fill" id="statsProgressFill"></div></div>
    </div>
  </div>

  <div id="rngCycleDisplay" style="display:none" class="rng-cycle-box">
    <div class="rng-cycle-icon">üîÑ</div>
    <div class="rng-cycle-text">
      <div class="rng-cycle-label" id="rngCycleLabel">RNG Cycle: Analyzing...</div>
      <div class="rng-cycle-desc" id="rngCycleDesc">Tracking pattern state across rounds</div>
    </div>
  </div>

  <div class="live-predictions-header">
    <div class="live-pred-title">üî¥ 90%+ Confidence Picks</div>
    <span class="high-conf-badge" id="highConfCount">0 picks</span>
  </div>

  <div id="accaBuilderDisplay"></div>
  <div id="livePredictionsContainer">
    <div class="empty-state">
      <div class="empty-icon">üì°</div>
      <div class="empty-title">Initializing Ultra Engine...</div>
      <div class="empty-desc">Loading real stats, trap detector, variance engine,<br>underdog analyzer & self-learning module.</div>
    </div>
  </div>
</div>

<!-- ==================== PREDICTOR TAB ==================== -->
<div class="section" id="tab-predictor">
  <div class="power-meter">
    <div class="meter-title"><span>üîã Round Power</span><span id="powerPercent">0%</span></div>
    <div class="meter-bar"><div class="meter-fill" id="powerFill" style="width:0%">0%</div></div>
    <div class="meter-labels"><span>Weak</span><span>Moderate</span><span>Strong</span><span>MAX</span></div>
  </div>
  <div class="main-grid">
    <div class="team-panel">
      <div class="panel-title">üè† HOME TEAMS</div>
      <div class="team-list" id="homeTeamList"></div>
    </div>
    <div class="team-panel">
      <div class="panel-title">‚úàÔ∏è AWAY TEAMS</div>
      <div class="team-list" id="awayTeamList"></div>
    </div>
    <div class="prediction-engine">
      <div class="engine-title">üéØ Dynamic Prediction Engine</div>
      <div class="match-display">
        <div class="team-box" id="homeBox"><div class="team-box-code">?</div><div class="team-box-name">Select Home</div><div class="team-box-stats"></div></div>
        <div class="vs-box">VS</div>
        <div class="team-box" id="awayBox"><div class="team-box-code">?</div><div class="team-box-name">Select Away</div><div class="team-box-stats"></div></div>
      </div>
      <div class="prediction-result" id="predictionResult">
        <div class="result-title">Select Teams to Predict</div>
        <div class="result-prediction">--</div>
        <div class="result-confidence" style="font-size:13px;color:var(--text2)">Awaiting selection...</div>
      </div>
      <div id="manualTrapDisplay"></div>
      <button class="add-match-btn" id="addMatchBtn" onclick="addMatch()" disabled>‚ûï ADD TO ROUND ANALYZER</button>
    </div>
    <div class="rating-calc" id="ratingCalc" style="display:none">
      <div class="calc-title">üìä Nairaland Rating Method</div>
      <div class="calc-grid">
        <div class="calc-item"><div class="calc-label">Home Rating</div><div class="calc-value" id="homeRatingVal">0</div></div>
        <div class="calc-item"><div class="calc-label">Away Rating</div><div class="calc-value" id="awayRatingVal">0</div></div>
        <div class="calc-item"><div class="calc-label">Combined</div><div class="calc-value" id="combinedRating">0</div></div>
        <div class="calc-item"><div class="calc-label">Signal</div><div class="calc-value" id="signalVal">--</div></div>
      </div>
      <div class="calc-formula">Over 2.5 = +3 | BTTS = +5 | Under = -3 | No BTTS = -5 | Combined &gt; 0 ‚Üí 90% Over 2.5</div>
    </div>
    <div class="match-history" id="matchHistory" style="display:none">
      <div class="history-title"><span>üìã Round Matches</span><button class="clear-btn" onclick="clearMatches()">Clear All</button></div>
      <div class="history-list" id="historyList"></div>
    </div>
  </div>
</div>

<!-- ==================== TEAM STATS TAB ==================== -->
<div class="section" id="tab-teamstats">
  <div class="alert alert-purple"><strong>üß† Dynamic Stats</strong> ‚Äî Real rates from BetPawa results. Purple = real data, Orange = static fallback.</div>
  <div class="team-stats-table" id="teamStatsTable">
    <div class="table-title">üìä Team Performance Data</div>
    <div id="teamStatsContent"><div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading Stats...</div></div></div>
  </div>
</div>

<!-- ==================== ANALYZER TAB ==================== -->
<div class="section" id="tab-analyzer">
  <div class="stats-panel">
    <div class="stats-grid">
      <div class="stat-item"><div class="stat-value" id="statMatches">0</div><div class="stat-label">Matches</div></div>
      <div class="stat-item"><div class="stat-value" id="statHighConf">0</div><div class="stat-label">High Conf</div></div>
      <div class="stat-item"><div class="stat-value" id="statAccuracy">0%</div><div class="stat-label">Avg Conf</div></div>
    </div>
  </div>
  <div class="alert alert-success" id="analyzerResult" style="display:none">
    <strong>‚úÖ ROUND ANALYSIS</strong><br><span id="analyzerText"></span>
  </div>
  <div class="strategy-panel">
    <div class="strategy-title">üéØ Recommended Bets This Round</div>
    <div class="strategy-grid" id="recommendations">
      <div class="strategy-card"><div class="strategy-name">No Data</div><div class="strategy-desc">Add matches in Predictor tab</div></div>
    </div>
  </div>
</div>

<!-- ==================== ML DATA TAB ==================== -->
<div class="section" id="tab-mldata">
  <div class="alert alert-ml"><strong>üß† ML Data Collector</strong> ‚Äî Persistent storage survives phone restarts & refreshes. Target: 10,000+ records for machine learning.</div>

  <div class="ml-panel">
    <div class="ml-panel-title">üìä Collection Status <span id="mlRefreshBtn" onclick="refreshMLDisplay()" style="font-size:10px;cursor:pointer;color:var(--ml)">‚Üª</span></div>
    <div class="ml-stats-grid">
      <div class="ml-stat"><div class="ml-stat-value" id="mlTotalRecords">0</div><div class="ml-stat-label">Total Records</div></div>
      <div class="ml-stat"><div class="ml-stat-value" id="mlLearningCycles">0</div><div class="ml-stat-label">Learn Cycles</div></div>
      <div class="ml-stat"><div class="ml-stat-value" id="mlFailuresLearned">0</div><div class="ml-stat-label">Failures Learned</div></div>
    </div>
    <div class="ml-progress-section">
      <div class="ml-progress-label"><span style="color:var(--ml)">Progress to Download Target</span><span id="mlProgressPct">0%</span></div>
      <div class="ml-progress-bar"><div class="ml-progress-fill" id="mlProgressFill" style="width:0%">0</div></div>
    </div>
    <button class="download-btn" id="downloadMLBtn" onclick="downloadMLData()">‚¨á DOWNLOAD ML DATASET (JSON)</button>
    <button class="clear-ml-btn" onclick="confirmClearML()">‚ö†Ô∏è Clear All ML Data (Irreversible)</button>
  </div>

  <div class="learn-panel">
    <div class="learn-title">ü§ñ Self-Learning Module <span id="learnStatus" style="font-size:9px;color:var(--text2)">Active</span></div>
    <div class="learn-cycle">Learning Cycles Completed: <strong id="learnCycles">0</strong> | Last learned: <span id="lastLearnTime">Never</span></div>
    <div style="margin-bottom:8px">
      <div style="font-size:9px;font-weight:700;color:var(--text2);margin-bottom:5px;text-transform:uppercase">Learned Adjustments (Auto-Applied)</div>
      <div class="learn-adjustment"><span class="learn-adj-name">‚ö° Trap Sensitivity</span><span class="learn-adj-val" id="adjTrapSens" style="color:var(--red)">1.0x</span></div>
      <div class="learn-adjustment"><span class="learn-adj-name">üìä Over Rate Boost</span><span class="learn-adj-val" id="adjOverRate" style="color:var(--green)">+0.0%</span></div>
      <div class="learn-adjustment"><span class="learn-adj-name">üéØ Confidence Floor</span><span class="learn-adj-val" id="adjConfFloor" style="color:var(--blue)">85%</span></div>
      <div class="learn-adjustment"><span class="learn-adj-name">üêâ Underdog Risk Threshold</span><span class="learn-adj-val" id="adjUnderdogRisk" style="color:var(--purple)">30%</span></div>
      <div class="learn-adjustment"><span class="learn-adj-name">üîÑ RNG Cycle Weight</span><span class="learn-adj-val" id="adjRngWeight" style="color:var(--orange)">1.0x</span></div>
    </div>
    <div style="font-size:9px;font-weight:700;color:var(--text2);margin-bottom:5px;text-transform:uppercase">Learning Log</div>
    <div class="learn-log" id="learnLog">No learning events yet. The system will log failures after each round comparison...</div>
  </div>
</div>

<!-- ==================== STRATEGIES TAB ==================== -->
<div class="section" id="tab-strategies">
  <div class="alert alert-warning"><strong>‚ö†Ô∏è ULTRA STRATEGIES ‚Äî Research-Based + RNG-Analyzed</strong></div>

  <div class="strategy-panel">
    <div class="strategy-title">ü•á TIER 1: Proven Winning Strategies (90-95%)</div>
    <div class="strategy-grid">
      <div class="strategy-card"><div class="strategy-name">League Activator Pattern</div><div class="strategy-desc">Every league has a "League Activator" team (highest-tier) that produces 4+ goal games. When Activator plays a Tier 3/4 team, Over 2.5 is 92%+ likely. Engine auto-detects this.</div></div>
      <div class="strategy-card"><div class="strategy-name">Post-High-Score Momentum</div><div class="strategy-desc">After any team produces 4+ goals in previous round, Over 2.5 probability for NEXT match is 90%+. RNG tends to continue momentum sequences in short cycles.</div></div>
      <div class="strategy-card"><div class="strategy-name">Dual Activator Clash</div><div class="strategy-desc">Both Tier 1 teams meeting = explosive game. Over 2.5: 88%+, BTTS: 75%+. Real data confirms 3-5 goals average in T1 vs T1 matchups.</div></div>
      <div class="strategy-card"><div class="strategy-name">Nairaland Rating Method</div><div class="strategy-desc">Last 4 matches: Over 2.5 = +3, BTTS = +5, Under = -3, No BTTS = -5. Combined &gt; +15 = 95%, &gt; 0 = 90% Over 2.5. Now uses real match data.</div></div>
    </div>
  </div>

  <div class="strategy-panel">
    <div class="strategy-title">üî¥ TRAP DETECTION GUIDE (Read Before Betting!)</div>
    <div class="strategy-grid">
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Low Odds Trap</div><div class="strategy-desc">Odds below 1.35 (implied 74%+ probability) signal system-programmed upset risk. The RNG balances by making huge favorites lose more often than odds suggest. AVOID bets with implied prob >74% on 1X2 market.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Consecutive Win Trap</div><div class="strategy-desc">When a team wins 4+ consecutive rounds, RNG correction triggers. The algorithm balances outcomes to prevent infinite winning streaks. Drop confidence by 15% after 4+ straight wins.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Round Correction Trap</div><div class="strategy-desc">After a round with 4+ over 2.5 results, the RNG matrix often corrects with under results next round. The detector tracks this and warns when over probability should be reduced.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Draw Danger Zone</div><div class="strategy-desc">Both teams with 35-40% draw rates in their history = Draw probability >45%. Over 2.5 is NOT safe here. BTTS market safer than Over goals when draw-prone teams meet.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è Algorithm Balance Trap</div><div class="strategy-desc">5+ consecutive favorites winning in a round = system about to upset bettors. The next 1-2 games in the round are statistically likely to produce underdog wins. High trap risk.</div></div>
      <div class="strategy-card trap"><div class="strategy-name">‚ö†Ô∏è BTTS Deception Trap</div><div class="strategy-desc">Teams with high BTTS (70%+) but low total goals avg don't reliably deliver Over 2.5. BTTS ‚â† Over 2.5. Check avg goals‚Äîif BTTS% is high but avg goals < 2.8, skip Over 2.5.</div></div>
    </div>
  </div>

  <div class="strategy-panel">
    <div class="strategy-title">üêâ UNDERDOG UPSET CONDITIONS (When Underdogs Win)</div>
    <div class="strategy-grid">
      <div class="strategy-card underdog"><div class="strategy-name">4+ Consecutive Wins</div><div class="strategy-desc">Favorite on 4+ consecutive wins triggers RNG reversion. Underdog win probability rises from statistical 20% to 38-45%. High value bet on underdog or Draw DC.</div></div>
      <div class="strategy-card underdog"><div class="strategy-name">Tier Gap with Away Form</div><div class="strategy-desc">Away Tier 2 team with 75%+ over rate last 5 = dangerous. They're likely in a "hot sequence." Meeting a Tier 1 team that just had a low-scoring game = upset window.</div></div>
      <div class="strategy-card underdog"><div class="strategy-name">Odds Sweet Spot</div><div class="strategy-desc">Underdog odds between 2.50-3.80 = highest value. The RNG weights give these outcomes 18-28% true probability, but historical data shows 22-35% actual occurrence. Positive expected value.</div></div>
      <div class="strategy-card underdog"><div class="strategy-name">Mirror Match Upset</div><div class="strategy-desc">When Tier 2 vs Tier 2 (same strength bands), 1X2 market is nearly 50/50. Never bet the favorite at 1.50 odds here. Look for DC (1X or X2) at 1.30+ instead.</div></div>
    </div>
  </div>

  <div class="strategy-panel">
    <div class="strategy-title">üí• VARIANCE: When 3+ Goals Are Nearly Guaranteed</div>
    <div class="strategy-grid">
      <div class="strategy-card variance"><div class="strategy-name">Double Activator Clash</div><div class="strategy-desc">Both teams are Tier 1 with 80%+ over rate. Combined avg goals > 3.5. Almost certain Over 3.5 (85%+). Best Over 3.5 entry point in the entire engine.</div></div>
      <div class="strategy-card variance"><div class="strategy-name">Activator vs Conceder</div><div class="strategy-desc">Tier 1 team (90%+ over rate) vs known conceder (Tier 4 team). Combined variance score ‚â• 5 = 93%+ Over 2.5. This is the "golden formula" in virtual football.</div></div>
      <div class="strategy-card variance"><div class="strategy-name">3-Game Over Streak</div><div class="strategy-desc">Home team in 3+ consecutive over 2.5 games AND away team same = variance locked. The RNG cycle tends to continue short streaks before correction. 4th game in sequence is ~80% over.</div></div>
      <div class="strategy-card variance"><div class="strategy-name">xG Explosion Threshold</div><div class="strategy-desc">When combined average goals for both teams exceeds 3.8/game, Over 3.5 becomes the primary bet. Not just Over 2.5. The system confirms this via real historical goals data.</div></div>
    </div>
  </div>

  <div class="alert"><strong>üö´ AVOID:</strong> Bets with Trap Score ‚â• 3 ¬∑ Odds under 1.35 on 1X2 ¬∑ 5+ consecutive favorites ¬∑ After 4+ round overs ¬∑ Chasing losses ¬∑ More than 5% bankroll per game</div>
  <div class="alert alert-ml"><strong>ü§ñ SELF-LEARNING:</strong> The engine tracks every prediction, compares with actual results, learns why it failed (trap missed, underdog surge, RNG correction) and auto-adjusts weights. Powered by persistent browser storage ‚Äî never lost even after phone restarts.</div>
</div>

</div><!-- end main-content -->

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <div class="bottom-nav-item active" onclick="showTab('live')" id="nav-live"><span class="nav-icon">üî¥</span>Live</div>
  <div class="bottom-nav-item" onclick="showTab('predictor')" id="nav-predictor"><span class="nav-icon">üéØ</span>Predict</div>
  <div class="bottom-nav-item" onclick="showTab('teamstats')" id="nav-teamstats"><span class="nav-icon">üìä</span>Stats</div>
  <div class="bottom-nav-item" onclick="showTab('analyzer')" id="nav-analyzer"><span class="nav-icon">üìà</span>Analyze</div>
  <div class="bottom-nav-item" onclick="showTab('mldata')" id="nav-mldata"><span class="nav-icon">üß†</span>ML</div>
  <div class="bottom-nav-item" onclick="showTab('strategies')" id="nav-strategies"><span class="nav-icon">üìö</span>Learn</div>
</div>

<script>
// ============================================================
// COMPLETED JAVASCRIPT - Full Implementation
// ============================================================

// ============================================================
// STATIC FALLBACK DATA ‚Äî ALL LEAGUES
// ============================================================
const VFL_DATA = {
  england: {
    name:'English League', apiName:'English League',
    conceders:['BUR','CRY','EVE','SUN'],
    teams:{
      'ARS':{name:'Arsenal',tier:1,overRate:90,bttsRate:72,homeAdv:1.15,drawRate:18, avgGoalsFor:2.3, avgGoalsAgainst:0.9},
      'MCI':{name:'Man City',tier:1,overRate:92,bttsRate:68,homeAdv:1.18,drawRate:15, avgGoalsFor:2.5, avgGoalsAgainst:0.8},
      'LIV':{name:'Liverpool',tier:1,overRate:88,bttsRate:74,homeAdv:1.15,drawRate:18, avgGoalsFor:2.2, avgGoalsAgainst:1.0},
      'TOT':{name:'Tottenham',tier:1,overRate:82,bttsRate:70,homeAdv:1.10,drawRate:20, avgGoalsFor:2.0, avgGoalsAgainst:1.2},
      'CHE':{name:'Chelsea',tier:1,overRate:80,bttsRate:68,homeAdv:1.10,drawRate:22, avgGoalsFor:1.9, avgGoalsAgainst:1.1},
      'MUN':{name:'Man United',tier:2,overRate:72,bttsRate:62,homeAdv:1.10,drawRate:25, avgGoalsFor:1.6, avgGoalsAgainst:1.3},
      'NEW':{name:'Newcastle',tier:2,overRate:70,bttsRate:60,homeAdv:1.08,drawRate:25, avgGoalsFor:1.5, avgGoalsAgainst:1.2},
      'AST':{name:'Aston Villa',tier:2,overRate:74,bttsRate:65,homeAdv:1.05,drawRate:23, avgGoalsFor:1.7, avgGoalsAgainst:1.3},
      'BHA':{name:'Brighton',tier:2,overRate:72,bttsRate:68,homeAdv:1.05,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.2},
      'FUL':{name:'Fulham',tier:2,overRate:68,bttsRate:60,homeAdv:1.05,drawRate:27, avgGoalsFor:1.4, avgGoalsAgainst:1.3},
      'WHU':{name:'West Ham',tier:3,overRate:62,bttsRate:55,homeAdv:1.05,drawRate:30, avgGoalsFor:1.3, avgGoalsAgainst:1.4},
      'BRE':{name:'Brentford',tier:3,overRate:65,bttsRate:58,homeAdv:1.05,drawRate:29, avgGoalsFor:1.4, avgGoalsAgainst:1.4},
      'NOT':{name:'Nott Forest',tier:3,overRate:58,bttsRate:52,homeAdv:1.00,drawRate:33, avgGoalsFor:1.2, avgGoalsAgainst:1.5},
      'LEE':{name:'Leeds United',tier:3,overRate:60,bttsRate:55,homeAdv:1.00,drawRate:30, avgGoalsFor:1.3, avgGoalsAgainst:1.5},
      'WOL':{name:'Wolves',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:32, avgGoalsFor:1.1, avgGoalsAgainst:1.3},
      'BUR':{name:'Burnley',tier:4,overRate:45,bttsRate:42,homeAdv:0.95,drawRate:38, avgGoalsFor:1.0, avgGoalsAgainst:1.8},
      'CRY':{name:'Crystal Palace',tier:4,overRate:48,bttsRate:44,homeAdv:0.95,drawRate:37, avgGoalsFor:1.0, avgGoalsAgainst:1.7},
      'EVE':{name:'Everton',tier:4,overRate:44,bttsRate:40,homeAdv:0.95,drawRate:40, avgGoalsFor:0.9, avgGoalsAgainst:1.6},
      'SUN':{name:'Sunderland',tier:4,overRate:42,bttsRate:38,homeAdv:0.92,drawRate:42, avgGoalsFor:0.8, avgGoalsAgainst:1.7},
      'BOU':{name:'Bournemouth',tier:4,overRate:46,bttsRate:42,homeAdv:0.92,drawRate:39, avgGoalsFor:1.0, avgGoalsAgainst:1.6}
    }
  },
  germany: {
    name:'Germany Bundesliga', apiName:'German League',
    conceders:['HSV','HEI','STP'],
    teams:{
      'FCB':{name:'Bayern Munich',tier:1,overRate:95,bttsRate:70,homeAdv:1.15,drawRate:12, avgGoalsFor:2.7, avgGoalsAgainst:0.8},
      'DOR':{name:'Dortmund',tier:1,overRate:90,bttsRate:75,homeAdv:1.10,drawRate:16, avgGoalsFor:2.4, avgGoalsAgainst:1.1},
      'RBL':{name:'RB Leipzig',tier:1,overRate:85,bttsRate:70,homeAdv:1.10,drawRate:18, avgGoalsFor:2.2, avgGoalsAgainst:1.1},
      'LEV':{name:'Leverkusen',tier:1,overRate:85,bttsRate:75,homeAdv:1.05,drawRate:18, avgGoalsFor:2.3, avgGoalsAgainst:1.2},
      'WOL':{name:'Wolfsburg',tier:1,overRate:80,bttsRate:65,homeAdv:1.05,drawRate:20, avgGoalsFor:2.0, avgGoalsAgainst:1.2},
      'FRE':{name:'Freiburg',tier:2,overRate:70,bttsRate:60,homeAdv:1.10,drawRate:26, avgGoalsFor:1.6, avgGoalsAgainst:1.3},
      'HOF':{name:'Hoffenheim',tier:2,overRate:70,bttsRate:70,homeAdv:1.00,drawRate:25, avgGoalsFor:1.7, avgGoalsAgainst:1.6},
      'UNI':{name:'Union Berlin',tier:2,overRate:65,bttsRate:55,homeAdv:1.05,drawRate:30, avgGoalsFor:1.4, avgGoalsAgainst:1.3},
      'STU':{name:'Stuttgart',tier:2,overRate:70,bttsRate:65,homeAdv:1.05,drawRate:24, avgGoalsFor:1.7, avgGoalsAgainst:1.5},
      'WER':{name:'Werder Bremen',tier:2,overRate:65,bttsRate:65,homeAdv:1.00,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.5},
      'COL':{name:'FC Koln',tier:3,overRate:55,bttsRate:55,homeAdv:1.00,drawRate:35, avgGoalsFor:1.2, avgGoalsAgainst:1.6},
      'MAI':{name:'Mainz',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.5},
      'MON':{name:"M'Gladbach",tier:3,overRate:60,bttsRate:60,homeAdv:1.00,drawRate:32, avgGoalsFor:1.4, avgGoalsAgainst:1.5},
      'AUG':{name:'Augsburg',tier:3,overRate:55,bttsRate:55,homeAdv:1.00,drawRate:35, avgGoalsFor:1.2, avgGoalsAgainst:1.6},
      'EIN':{name:'Eintracht',tier:3,overRate:60,bttsRate:60,homeAdv:1.00,drawRate:30, avgGoalsFor:1.4, avgGoalsAgainst:1.4},
      'HSV':{name:'Hamburg',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:43, avgGoalsFor:1.0, avgGoalsAgainst:1.9},
      'HEI':{name:'Heidenheim',tier:4,overRate:40,bttsRate:45,homeAdv:0.95,drawRate:42, avgGoalsFor:1.0, avgGoalsAgainst:1.8},
      'STP':{name:'St Pauli',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:45, avgGoalsFor:0.9, avgGoalsAgainst:2.0}
    }
  },
  italy: {
    name:'Italy Serie A', apiName:'Italian League',
    conceders:['LEC','CRE','COM','PAR','PIS'],
    teams:{
      'INT':{name:'Inter Milan',tier:1,overRate:85,bttsRate:65,homeAdv:1.15,drawRate:20, avgGoalsFor:2.2, avgGoalsAgainst:0.9},
      'MIL':{name:'AC Milan',tier:1,overRate:85,bttsRate:70,homeAdv:1.10,drawRate:22, avgGoalsFor:2.1, avgGoalsAgainst:1.0},
      'NAP':{name:'Napoli',tier:1,overRate:80,bttsRate:70,homeAdv:1.10,drawRate:22, avgGoalsFor:2.0, avgGoalsAgainst:1.1},
      'ATA':{name:'Atalanta',tier:1,overRate:90,bttsRate:75,homeAdv:1.05,drawRate:17, avgGoalsFor:2.3, avgGoalsAgainst:1.2},
      'JUV':{name:'Juventus',tier:1,overRate:70,bttsRate:55,homeAdv:1.10,drawRate:28, avgGoalsFor:1.6, avgGoalsAgainst:0.9},
      'ROM':{name:'AS Roma',tier:2,overRate:75,bttsRate:65,homeAdv:1.10,drawRate:24, avgGoalsFor:1.8, avgGoalsAgainst:1.2},
      'LAZ':{name:'Lazio',tier:2,overRate:70,bttsRate:60,homeAdv:1.10,drawRate:26, avgGoalsFor:1.7, avgGoalsAgainst:1.2},
      'FIO':{name:'Fiorentina',tier:2,overRate:65,bttsRate:60,homeAdv:1.05,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.3},
      'BOL':{name:'Bologna',tier:2,overRate:65,bttsRate:55,homeAdv:1.05,drawRate:29, avgGoalsFor:1.5, avgGoalsAgainst:1.3},
      'TOR':{name:'Torino',tier:2,overRate:55,bttsRate:45,homeAdv:1.05,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.2},
      'VER':{name:'Verona',tier:3,overRate:60,bttsRate:55,homeAdv:1.00,drawRate:32, avgGoalsFor:1.3, avgGoalsAgainst:1.5},
      'SAS':{name:'Sassuolo',tier:3,overRate:65,bttsRate:60,homeAdv:1.00,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.6},
      'UDI':{name:'Udinese',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.4},
      'CAG':{name:'Cagliari',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.5},
      'GEN':{name:'Genoa',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.5},
      'LEC':{name:'Lecce',tier:4,overRate:40,bttsRate:40,homeAdv:0.95,drawRate:42, avgGoalsFor:0.9, avgGoalsAgainst:1.7},
      'CRE':{name:'Cremonese',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:44, avgGoalsFor:0.8, avgGoalsAgainst:1.9},
      'COM':{name:'Como',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:44, avgGoalsFor:0.8, avgGoalsAgainst:1.8},
      'PAR':{name:'Parma',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:42, avgGoalsFor:0.9, avgGoalsAgainst:1.7},
      'PIS':{name:'Pisa',tier:4,overRate:35,bttsRate:30,homeAdv:0.85,drawRate:46, avgGoalsFor:0.7, avgGoalsAgainst:2.0}
    }
  },
  spain: {
    name:'Spain La Liga', apiName:'Spanish League',
    conceders:['ALA','ELC','LEV','OVI','GIR'],
    teams:{
      'RMA':{name:'Real Madrid',tier:1,overRate:90,bttsRate:70,homeAdv:1.15,drawRate:15, avgGoalsFor:2.4, avgGoalsAgainst:0.8},
      'BAR':{name:'Barcelona',tier:1,overRate:90,bttsRate:75,homeAdv:1.15,drawRate:15, avgGoalsFor:2.3, avgGoalsAgainst:0.9},
      'ATM':{name:'Atletico Madrid',tier:1,overRate:75,bttsRate:60,homeAdv:1.10,drawRate:28, avgGoalsFor:1.7, avgGoalsAgainst:0.9},
      'SEV':{name:'Sevilla',tier:1,overRate:75,bttsRate:65,homeAdv:1.10,drawRate:26, avgGoalsFor:1.8, avgGoalsAgainst:1.2},
      'VIL':{name:'Villarreal',tier:1,overRate:80,bttsRate:70,homeAdv:1.05,drawRate:22, avgGoalsFor:2.0, avgGoalsAgainst:1.2},
      'RSO':{name:'Real Sociedad',tier:2,overRate:65,bttsRate:60,homeAdv:1.10,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.2},
      'BET':{name:'Real Betis',tier:2,overRate:70,bttsRate:65,homeAdv:1.05,drawRate:26, avgGoalsFor:1.6, avgGoalsAgainst:1.3},
      'ATH':{name:'Athletic Bilbao',tier:2,overRate:65,bttsRate:55,homeAdv:1.10,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.1},
      'CEL':{name:'Celta Vigo',tier:2,overRate:70,bttsRate:65,homeAdv:1.00,drawRate:26, avgGoalsFor:1.6, avgGoalsAgainst:1.5},
      'GET':{name:'Getafe',tier:2,overRate:55,bttsRate:45,homeAdv:1.05,drawRate:35, avgGoalsFor:1.1, avgGoalsAgainst:1.2},
      'VAL':{name:'Valencia',tier:3,overRate:55,bttsRate:50,homeAdv:1.05,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.4},
      'OSA':{name:'Osasuna',tier:3,overRate:50,bttsRate:45,homeAdv:1.05,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.3},
      'RAY':{name:'Rayo Vallecano',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:33, avgGoalsFor:1.2, avgGoalsAgainst:1.4},
      'MAL':{name:'Mallorca',tier:3,overRate:45,bttsRate:40,homeAdv:1.00,drawRate:38, avgGoalsFor:1.0, avgGoalsAgainst:1.4},
      'ESP':{name:'Espanyol',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.5},
      'ALA':{name:'Alaves',tier:4,overRate:40,bttsRate:40,homeAdv:0.95,drawRate:43, avgGoalsFor:0.9, avgGoalsAgainst:1.7},
      'ELC':{name:'Elche',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:45, avgGoalsFor:0.8, avgGoalsAgainst:1.9},
      'GIR':{name:'Girona',tier:4,overRate:45,bttsRate:45,homeAdv:0.95,drawRate:41, avgGoalsFor:1.0, avgGoalsAgainst:1.6},
      'LEV':{name:'Levante',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:43, avgGoalsFor:0.9, avgGoalsAgainst:1.7},
      'OVI':{name:'Oviedo',tier:4,overRate:35,bttsRate:30,homeAdv:0.85,drawRate:46, avgGoalsFor:0.7, avgGoalsAgainst:1.9}
    }
  },
  france: {
    name:'France Ligue 1', apiName:'French League',
    conceders:['ANG','LOR','HAV'],
    teams:{
      'PSG':{name:'Paris SG',tier:1,overRate:90,bttsRate:70,homeAdv:1.15,drawRate:14, avgGoalsFor:2.5, avgGoalsAgainst:0.8},
      'ASM':{name:'Monaco',tier:1,overRate:85,bttsRate:70,homeAdv:1.10,drawRate:18, avgGoalsFor:2.2, avgGoalsAgainst:1.1},
      'MAR':{name:'Marseille',tier:1,overRate:80,bttsRate:70,homeAdv:1.10,drawRate:22, avgGoalsFor:2.0, avgGoalsAgainst:1.1},
      'REN':{name:'Rennes',tier:1,overRate:75,bttsRate:65,homeAdv:1.05,drawRate:24, avgGoalsFor:1.9, avgGoalsAgainst:1.2},
      'LEN':{name:'Lens',tier:1,overRate:70,bttsRate:60,homeAdv:1.05,drawRate:25, avgGoalsFor:1.7, avgGoalsAgainst:1.1},
      'NIC':{name:'Nice',tier:2,overRate:65,bttsRate:55,homeAdv:1.10,drawRate:29, avgGoalsFor:1.5, avgGoalsAgainst:1.1},
      'LYO':{name:'Lyon',tier:2,overRate:70,bttsRate:65,homeAdv:1.05,drawRate:26, avgGoalsFor:1.7, avgGoalsAgainst:1.3},
      'LIL':{name:'Lille',tier:2,overRate:65,bttsRate:55,homeAdv:1.10,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.2},
      'STR':{name:'Strasbourg',tier:2,overRate:60,bttsRate:55,homeAdv:1.00,drawRate:32, avgGoalsFor:1.4, avgGoalsAgainst:1.4},
      'TOU':{name:'Toulouse',tier:2,overRate:60,bttsRate:50,homeAdv:1.00,drawRate:32, avgGoalsFor:1.3, avgGoalsAgainst:1.4},
      'BRE':{name:'Brest',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.5},
      'NAN':{name:'Nantes',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.5},
      'MET':{name:'Metz',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.5},
      'AUX':{name:'Auxerre',tier:3,overRate:45,bttsRate:40,homeAdv:0.95,drawRate:39, avgGoalsFor:1.0, avgGoalsAgainst:1.6},
      'PAR':{name:'Paris FC',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.5},
      'ANG':{name:'Angers',tier:4,overRate:35,bttsRate:30,homeAdv:0.90,drawRate:45, avgGoalsFor:0.8, avgGoalsAgainst:2.0},
      'LOR':{name:'Lorient',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:43, avgGoalsFor:0.9, avgGoalsAgainst:1.8},
      'HAV':{name:'Le Havre',tier:4,overRate:35,bttsRate:35,homeAdv:0.85,drawRate:46, avgGoalsFor:0.8, avgGoalsAgainst:1.9}
    }
  },
  portugal: {
    name:'Portugal Primeira', apiName:'Portuguese League',
    conceders:['AVS','GIL','ALV'],
    teams:{
      'BEN':{name:'Benfica',tier:1,overRate:90,bttsRate:70,homeAdv:1.15,drawRate:15, avgGoalsFor:2.4, avgGoalsAgainst:0.7},
      'SPO':{name:'Sporting CP',tier:1,overRate:90,bttsRate:75,homeAdv:1.15,drawRate:15, avgGoalsFor:2.3, avgGoalsAgainst:0.8},
      'POR':{name:'Porto',tier:1,overRate:85,bttsRate:70,homeAdv:1.15,drawRate:17, avgGoalsFor:2.2, avgGoalsAgainst:0.9},
      'BRA':{name:'Braga',tier:1,overRate:80,bttsRate:65,homeAdv:1.10,drawRate:21, avgGoalsFor:2.0, avgGoalsAgainst:1.1},
      'GUI':{name:'Guimaraes',tier:1,overRate:75,bttsRate:65,homeAdv:1.05,drawRate:24, avgGoalsFor:1.8, avgGoalsAgainst:1.2},
      'SAN':{name:'Santa Clara',tier:2,overRate:65,bttsRate:55,homeAdv:1.05,drawRate:28, avgGoalsFor:1.4, avgGoalsAgainst:1.3},
      'FAM':{name:'Famalicao',tier:2,overRate:70,bttsRate:60,homeAdv:1.00,drawRate:26, avgGoalsFor:1.6, avgGoalsAgainst:1.4},
      'CAS':{name:'Casa Pia',tier:2,overRate:60,bttsRate:50,homeAdv:1.00,drawRate:30, avgGoalsFor:1.3, avgGoalsAgainst:1.4},
      'EST':{name:'Estoril',tier:2,overRate:65,bttsRate:55,homeAdv:1.00,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.5},
      'RIO':{name:'Rio Ave',tier:2,overRate:65,bttsRate:55,homeAdv:1.05,drawRate:28, avgGoalsFor:1.4, avgGoalsAgainst:1.4},
      'ARO':{name:'Arouca',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.6},
      'MOR':{name:'Moreirense',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.5},
      'NAC':{name:'Nacional',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.6},
      'TON':{name:'Tondela',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.6},
      'ETA':{name:'Estrela',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.6},
      'AVS':{name:'AVS',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:44, avgGoalsFor:0.8, avgGoalsAgainst:1.9},
      'GIL':{name:'Gil Vicente',tier:4,overRate:40,bttsRate:40,homeAdv:0.90,drawRate:42, avgGoalsFor:0.9, avgGoalsAgainst:1.8},
      'ALV':{name:'Alverca',tier:4,overRate:35,bttsRate:30,homeAdv:0.85,drawRate:46, avgGoalsFor:0.7, avgGoalsAgainst:2.0}
    }
  },
  netherlands: {
    name:'Netherlands Eredivisie', apiName:'Dutch League',
    conceders:['PEC','NAC','VOL'],
    teams:{
      'AJA':{name:'Ajax',tier:1,overRate:90,bttsRate:75,homeAdv:1.15,drawRate:15, avgGoalsFor:2.5, avgGoalsAgainst:0.9},
      'PSV':{name:'PSV',tier:1,overRate:90,bttsRate:70,homeAdv:1.15,drawRate:15, avgGoalsFor:2.4, avgGoalsAgainst:0.9},
      'FEY':{name:'Feyenoord',tier:1,overRate:85,bttsRate:75,homeAdv:1.10,drawRate:18, avgGoalsFor:2.2, avgGoalsAgainst:1.0},
      'AZA':{name:'AZ Alkmaar',tier:1,overRate:80,bttsRate:65,homeAdv:1.10,drawRate:21, avgGoalsFor:2.0, avgGoalsAgainst:1.1},
      'TWE':{name:'Twente',tier:1,overRate:75,bttsRate:65,homeAdv:1.05,drawRate:24, avgGoalsFor:1.8, avgGoalsAgainst:1.2},
      'UTR':{name:'Utrecht',tier:2,overRate:70,bttsRate:60,homeAdv:1.10,drawRate:26, avgGoalsFor:1.6, avgGoalsAgainst:1.3},
      'HEE':{name:'Heerenveen',tier:2,overRate:65,bttsRate:60,homeAdv:1.05,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.5},
      'FOR':{name:'Fortuna',tier:2,overRate:65,bttsRate:55,homeAdv:1.00,drawRate:28, avgGoalsFor:1.4, avgGoalsAgainst:1.5},
      'HER':{name:'Heracles',tier:2,overRate:60,bttsRate:55,homeAdv:1.00,drawRate:30, avgGoalsFor:1.3, avgGoalsAgainst:1.5},
      'EXC':{name:'Excelsior',tier:2,overRate:65,bttsRate:60,homeAdv:1.00,drawRate:28, avgGoalsFor:1.5, avgGoalsAgainst:1.6},
      'GAE':{name:'Go Ahead',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.6},
      'GRO':{name:'Groningen',tier:3,overRate:50,bttsRate:45,homeAdv:1.00,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.6},
      'TEL':{name:'Telstar',tier:3,overRate:50,bttsRate:45,homeAdv:0.95,drawRate:36, avgGoalsFor:1.1, avgGoalsAgainst:1.7},
      'NEC':{name:'NEC',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.6},
      'SPA':{name:'Sparta',tier:3,overRate:55,bttsRate:50,homeAdv:1.00,drawRate:34, avgGoalsFor:1.2, avgGoalsAgainst:1.6},
      'PEC':{name:'PEC Zwolle',tier:4,overRate:40,bttsRate:40,homeAdv:0.95,drawRate:42, avgGoalsFor:0.9, avgGoalsAgainst:1.8},
      'NAC':{name:'NAC Breda',tier:4,overRate:35,bttsRate:35,homeAdv:0.90,drawRate:44, avgGoalsFor:0.8, avgGoalsAgainst:1.9},
      'VOL':{name:'Volendam',tier:4,overRate:35,bttsRate:35,homeAdv:0.85,drawRate:46, avgGoalsFor:0.8, avgGoalsAgainst:2.0}
    }
  }
};

// ============================================================
// GLOBAL STATE
// ============================================================
const state = {
  currentLeague: 'england',
  selectedHome: null,
  selectedAway: null,
  matches: [],
  liveData: null,
  countdownInterval: null,
  cardTimerInterval: null,
  notifInterval: null,
  refreshTimeout: null,
  highConfPicks: [],
  dynamicStats: {},
  statsLoaded: false,
  totalRealMatches: 0,
  teamsWithRealData: 0,
  statsLoadProgress: 0,
  roundHistory: [],       // track last N round results for RNG cycle detection
  rngCycleState: null,    // current RNG pattern state
  db: null,               // IndexedDB instance
  learnedAdjustments: {   // loaded from DB, applied to all predictions
    trapSensitivity: 1.0,
    overRateBoost: 0,
    confidenceFloor: 85,
    underdogRiskThreshold: 30,
    rngCycleWeight: 1.0,
    learnCycles: 0,
    failuresLearned: 0,
    log: []
  }
};

let isLiveTabActive = true;
let isPageVisible = true;

// ============================================================
// API CONFIG ‚Äî with timeout, retry, and CORS fallbacks
// ============================================================
const API = {
  BASE: 'https://betpawa-proxy-production.up.railway.app',
  BRAND: 'betpawa-zambia',
  retryCount: 0,
  maxRetries: 3,

  async fetchWithTimeout(url, options = {}, timeoutMs = 12000) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeoutMs);
    try {
      const res = await fetch(url, { ...options, signal: controller.signal });
      clearTimeout(timer);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    } catch(e) {
      clearTimeout(timer);
      if (e.name === 'AbortError') throw new Error('Request timed out after ' + (timeoutMs/1000) + 's');
      throw e;
    }
  },

  async get(path, retries = 2) {
    let lastErr;
    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        if (attempt > 0) await new Promise(r => setTimeout(r, 2000 * attempt));
        return await this.fetchWithTimeout(this.BASE + path, {
          headers: { 'X-Pawa-Brand': this.BRAND, 'Content-Type': 'application/json' }
        }, 14000);
      } catch(e) {
        lastErr = e;
        console.warn(`[API] Attempt ${attempt+1} failed: ${e.message}`);
      }
    }
    throw lastErr;
  },

  async fetchSeasons() { return this.get('/api/sportsbook/virtual/v1/seasons/list/actual'); },
  async fetchRound(roundId, page) { return this.get(`/api/sportsbook/virtual/v2/events/list/by-round/${roundId}?page=${page}`); }
};

// ============================================================
// INDEXEDDB ‚Äî PERSISTENT STORAGE ENGINE
// ============================================================
function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('BetpawaPredictorUltraDB', 3);
    req.onerror = () => reject(req.error);
    req.onsuccess = () => { state.db = req.result; resolve(); };
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('mlData')) {
        const s = db.createObjectStore('mlData', { keyPath: 'id', autoIncrement: true });
        s.createIndex('timestamp', 'timestamp');
        s.createIndex('league', 'league');
      }
      if (!db.objectStoreNames.contains('learnings')) {
        db.createObjectStore('learnings', { keyPath: 'key' });
      }
      if (!db.objectStoreNames.contains('roundResults')) {
        const r = db.createObjectStore('roundResults', { keyPath: 'roundId' });
        r.createIndex('timestamp', 'timestamp');
      }
    };
  });
}

function dbGet(store, key) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(null);
    const tx = state.db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => resolve(null);
  });
}

function dbPut(store, value) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(false);
    const tx = state.db.transaction(store, 'readwrite');
    tx.objectStore(store).put(value);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => resolve(false);
  });
}

function dbAdd(store, value) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(false);
    const tx = state.db.transaction(store, 'readwrite');
    tx.objectStore(store).add(value);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => resolve(false);
  });
}

function dbCount(store) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(0);
    const tx = state.db.transaction(store, 'readonly');
    const req = tx.objectStore(store).count();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => resolve(0);
  });
}

function dbGetAll(store) {
  return new Promise((resolve) => {
    if (!state.db) return resolve([]);
    const tx = state.db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => resolve([]);
  });
}

function dbClear(store) {
  return new Promise((resolve) => {
    if (!state.db) return resolve(false);
    const tx = state.db.transaction(store, 'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => resolve(false);
  });
}

// ============================================================
// LOAD / SAVE LEARNED ADJUSTMENTS
// ============================================================
async function loadLearnedAdjustments() {
  const saved = await dbGet('learnings', 'adjustments');
  if (saved && saved.data) {
    state.learnedAdjustments = { ...state.learnedAdjustments, ...saved.data };
  }
  renderLearnedAdjustments();
  updateMLDisplay();
}

async function saveLearnedAdjustments() {
  await dbPut('learnings', { key: 'adjustments', data: state.learnedAdjustments, updated: Date.now() });
  renderLearnedAdjustments();
}

function renderLearnedAdjustments() {
  const la = state.learnedAdjustments;
  const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
  el('adjTrapSens', la.trapSensitivity.toFixed(2) + 'x');
  el('adjOverRate', (la.overRateBoost >= 0 ? '+' : '') + la.overRateBoost.toFixed(1) + '%');
  el('adjConfFloor', la.confidenceFloor + '%');
  el('adjUnderdogRisk', la.underdogRiskThreshold + '%');
  el('adjRngWeight', la.rngCycleWeight.toFixed(2) + 'x');
  el('learnCycles', la.learnCycles);
  el('dqLearned', la.learnCycles + ' cycles');
  if (la.log && la.log.length > 0) {
    const logEl = document.getElementById('learnLog');
    if (logEl) logEl.textContent = la.log.slice(-30).reverse().join('\n');
  }
  if (la.learnCycles > 0) {
    const d = new Date();
    const tle = document.getElementById('lastLearnTime');
    if (tle) tle.textContent = d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
  }
}

// ============================================================
// ML DATA COLLECTOR
// ============================================================
async function storePrediction(pred, leagueKey, roundId) {
  const record = {
    timestamp: Date.now(),
    roundId: roundId || 'unknown',
    league: leagueKey,
    homeCode: pred.homeCode,
    awayCode: pred.awayCode,
    prediction: pred.prediction,
    confidence: pred.confidence,
    overProb: pred.overProb,
    bttsProb: pred.bttsProb,
    dataSource: pred.dataSource,
    homeOverRate: pred.home?.overRate || 0,
    awayOverRate: pred.away?.overRate || 0,
    homeBttsRate: pred.home?.bttsRate || 0,
    awayBttsRate: pred.away?.bttsRate || 0,
    homeAvgGoals: pred.home?.avgGoalsFor || 0,
    awayAvgGoals: pred.away?.avgGoalsFor || 0,
    homeTier: pred.home?.tier || 2,
    awayTier: pred.away?.tier || 2,
    trapScore: pred.trapAnalysis?.totalTrapScore || 0,
    underdogRisk: pred.underdogAnalysis?.underdogRisk || 0,
    varianceScore: pred.varianceAnalysis?.varianceScore || 0,
    rngCycleState: state.rngCycleState?.state || 'neutral',
    traps: pred.trapAnalysis?.traps?.map(t => t.id) || [],
    // Actual result filled in later by self-learner
    actualResult: null,
    actualGoals: null,
    wasCorrect: null,
    failureReason: null
  };
  await dbAdd('mlData', record);
  updateMLDisplay();
}

async function updateMLDisplay() {
  const count = await dbCount('mlData');
  const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
  el('mlTotalRecords', count.toLocaleString());
  el('dqML', count.toLocaleString());
  el('mlLearningCycles', state.learnedAdjustments.learnCycles);
  el('mlFailuresLearned', state.learnedAdjustments.failuresLearned);
  const pct = Math.min(100, Math.round((count / 10000) * 100));
  el('mlProgressPct', pct + '%');
  const fill = document.getElementById('mlProgressFill');
  if (fill) { fill.style.width = pct + '%'; fill.textContent = count.toLocaleString() + ' / 10,000'; }
  const dlBtn = document.getElementById('downloadMLBtn');
  if (dlBtn) dlBtn.textContent = `‚¨á DOWNLOAD ML DATASET (${count.toLocaleString()} records)`;
}

async function refreshMLDisplay() { await updateMLDisplay(); }

async function downloadMLData() {
  const records = await dbGetAll('mlData');
  if (records.length === 0) { alert('No data collected yet!'); return; }
  const blob = new Blob([JSON.stringify({ exportDate: new Date().toISOString(), totalRecords: records.length, version: '3.0', data: records }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `betpawa_ml_data_${records.length}_records_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function confirmClearML() {
  if (confirm('‚ö†Ô∏è This will permanently delete ALL ML data. This cannot be undone. Continue?')) {
    await dbClear('mlData');
    await updateMLDisplay();
    alert('ML data cleared.');
  }
}

// ============================================================
// INTEGRATED FORMULA ENGINE
// ============================================================
function calculateFormulas(home, away, homeCode, awayCode, league) {
  // This function implements the specific formulas requested
  let score = 50; // Base score
  const reasons = [];
  
  // 1. GPI Formula (Proxy using Tiers)
  // T1 vs T4 implies strong favorite (Odds ~1.25)
  const tierDiff = home.tier - away.tier;
  if (tierDiff >= 2) {
    score += 25; // GPI High
    reasons.push(`GPI Dominance (+25)`);
  } else if (tierDiff === 1) {
    score += 10;
  } else if (tierDiff <= -2) {
    score -= 15; // Away Favorite
  }

  // 2. 1.30 Threshold (Favorite Sweet Spot)
  // T1 home vs T3/T4 away represents the 1.20-1.35 odds range
  if (home.tier === 1 && away.tier >= 3) {
    score += 20;
    reasons.push(`Threshold Boost (+20)`);
  }

  // 3. Revenge Script (Favorite lost/drew last match)
  // We check if the last match had low goals for a T1 team
  if (home.tier === 1 && home.form && home.form.length > 0) {
    const lastMatchGoals = home.form[0];
    if (lastMatchGoals <= 1) { // Likely a loss or draw for a T1 team
      score += 25;
      reasons.push(`Revenge Script (+25)`);
    }
  }

  // 4. Form Cycle Reversion (2 consecutive Unders -> Expect Over)
  if (home.form && home.form.length >= 2) {
    if (home.form[0] <= 2 && home.form[1] <= 2) {
      score += 15;
      reasons.push(`Cycle Reversion (+15)`);
    }
  }

  // 5. Z-Code (Top vs Bottom)
  if (home.tier === 1 && away.tier === 4) {
    score += 15;
    reasons.push(`Z-Code Rout (+15)`);
  }

  return { score, reasons };
}

// ============================================================
// TRAP DETECTION SYSTEM (Filters)
// ============================================================
function detectTraps(homeCode, awayCode, leagueKey) {
  const traps = [];
  const league = VFL_DATA[leagueKey];
  const home = getTeamStats(homeCode, leagueKey);
  const away = getTeamStats(awayCode, leagueKey);
  const st = league?.teams[homeCode];
  const sa = league?.teams[awayCode];
  const sens = state.learnedAdjustments.trapSensitivity;

  // TRAP 1: Streak Buster (3+ consecutive Overs)
  if (home.form && home.form.length >= 3) {
    const recentHighScores = home.form.slice(0, 3).filter(g => g > 2).length;
    if (recentHighScores >= 3) {
      traps.push({ id: 'streak_buster', level: 'high', text: '‚ö†Ô∏è Streak Buster: Home team on 3+ Over streak. Algorithm saturation reached. Expect Under.', reduction: 30 * sens });
    }
  }

  // TRAP 2: Mutual Destruction (T1 vs T1 with high draw rates)
  if (home.tier === 1 && away.tier === 1 && (st?.drawRate || 0) >= 20 && (sa?.drawRate || 0) >= 20) {
      traps.push({ id: 'mutual_destruction', level: 'med', text: '‚ö†Ô∏è Mutual Destruction: T1 vs T1. Stats cancel out. High draw risk.', reduction: 15 * sens });
  }

  // TRAP 3: Odds Trap (Odds too low implies bait)
  // T1 vs T4 with extremely high over rates sometimes corrects
  if (home.tier === 1 && away.tier === 4 && home.overRate > 90) {
      traps.push({ id: 'odds_trap', level: 'low', text: '‚ö†Ô∏è Odds Trap: Heavy favorite. Check for value.', reduction: 10 * sens });
  }

  // TRAP 4: Round Correction
  const rngState = state.rngCycleState;
  if (rngState && rngState.consecutiveOvers >= 4) {
    traps.push({ id: 'round_correction', level: 'high', text: `‚ö†Ô∏è Round Correction: ${rngState.consecutiveOvers} Overs in a row. RNG Matrix correcting.`, reduction: 20 * sens });
  }

  const totalTrapScore = traps.length * 3 + traps.filter(t => t.level === 'high').length * 5;
  const totalReduction = traps.reduce((s, t) => s + (t.reduction || 0), 0);

  return { traps, totalTrapScore, totalReduction, isSafe: totalTrapScore < 9, isDangerous: totalTrapScore >= 15 };
}

// ============================================================
// UNDERDOG UPSET ANALYZER
// ============================================================
function analyzeUnderdogUpset(homeCode, awayCode, leagueKey) {
  const conditions = [];
  const home = getTeamStats(homeCode, leagueKey);
  const away = getTeamStats(awayCode, leagueKey);
  let underdogRisk = 0;
  const thresh = state.learnedAdjustments.underdogRiskThreshold;

  // Condition 1: Favorite on consecutive high scores -> RNG reversion
  if (home.form && home.form.length >= 4) {
    const wins = home.form.slice(0, 4).filter(g => g > 2).length;
    if (wins >= 4) { conditions.push({ icon: 'üîÑ', text: `Home on 4+ high-score streak ‚Äî RNG reversion: +25% underdog`, weight: 25 }); underdogRisk += 25; }
    else if (wins >= 3) { conditions.push({ icon: '‚ö°', text: 'Home on 3-game high-score run ‚Äî mild reversion risk', weight: 12 }); underdogRisk += 12; }
  }

  // Condition 2: Tier gap with hot away form
  if (home.tier < away.tier && away.recentOverRate >= 75 && away.form.length >= 3) {
    conditions.push({ icon: 'üî•', text: `Underdog away team in HOT form (${away.recentOverRate}% recent over). Upset window open.`, weight: 20 }); underdogRisk += 20;
  }

  // Condition 3: Odds sweet spot (away tier = 2, home tier = 1)
  if (home.tier === 1 && away.tier === 2) {
    conditions.push({ icon: 'üí∞', text: 'Away Tier 2 vs Home Tier 1: Underdog odds 2.50-3.80 range = positive EV zone', weight: 15 }); underdogRisk += 15;
  }

  // Condition 4: Mirror match upset
  if (home.tier === away.tier && home.tier >= 2) {
    conditions.push({ icon: '‚öñÔ∏è', text: `Equal tier matchup (Tier ${home.tier}): True 50/50 ‚Äî underdog by default is away team`, weight: 18 }); underdogRisk += 18;
  }

  // Condition 5: Algorithm Balance state
  const rng = state.rngCycleState;
  if (rng && rng.consecutiveFavoriteWins >= 4) {
    conditions.push({ icon: 'ü§ñ', text: `Algorithm balancing: ${rng.consecutiveFavoriteWins} favs won. System due for upset.`, weight: 30 }); underdogRisk += 30;
  }

  // Condition 6: Away underdog with conceder home defense
  if (VFL_DATA[leagueKey]?.conceders?.includes(homeCode) && away.tier <= 2) {
    conditions.push({ icon: 'üéØ', text: 'Home team is known conceder ‚Äî Away team has real chance despite lower tier', weight: 20 }); underdogRisk += 20;
  }

  const isHighRisk = underdogRisk >= thresh;
  const recommendation = underdogRisk >= 60 ? 'üî¥ HIGH UPSET RISK ‚Äî Consider Away DC (X2) or skip' :
                         underdogRisk >= thresh ? 'üü° Moderate upset risk ‚Äî Reduce stake or hedge' :
                         'üü¢ Low upset risk ‚Äî Prediction reliable';

  return { conditions, underdogRisk: Math.min(100, underdogRisk), isHighRisk, recommendation };
}

// ============================================================
// VARIANCE DETECTOR (3+ goals guarantee conditions)
// ============================================================
function detectVariance(homeCode, awayCode, leagueKey) {
  const league = VFL_DATA[leagueKey];
  const home = getTeamStats(homeCode, leagueKey);
  const away = getTeamStats(awayCode, leagueKey);
  const signals = [];
  let varianceScore = 0;

  // Signal 1: Activator vs Conceder (GOLDEN FORMULA)
  if (home.tier === 1 && league?.conceders?.includes(awayCode)) {
    signals.push({ icon: 'üèÜ', text: 'GOLDEN FORMULA: Tier-1 Activator vs Known Conceder ‚Äî Over 2.5: 93%+, Over 3.5: 75%+', power: 3 }); varianceScore += 3;
  }

  // Signal 2: Double Activator Clash
  if (home.tier === 1 && away.tier === 1) {
    signals.push({ icon: 'üí•', text: `Dual Activator Clash: Both T1 teams. Combined O2.5: ${Math.round((home.overRate + away.overRate)/2)}%. Over 3.5 real possibility.`, power: 3 }); varianceScore += 3;
  }

  // Signal 3: Combined high over rates
  const combinedOver = (home.overRate + away.overRate) / 2;
  if (combinedOver >= 85) {
    signals.push({ icon: 'üìà', text: `Super High Combined Over Rate: ${combinedOver.toFixed(0)}% avg ‚Äî almost certain 3+ goals`, power: 2 }); varianceScore += 2;
  } else if (combinedOver >= 75) {
    signals.push({ icon: 'üìä', text: `High Combined Over Rate: ${combinedOver.toFixed(0)}% ‚Äî strong over signal`, power: 1 }); varianceScore += 1;
  }

  // Signal 4: Goals explosion via averages
  const totalAvgGoals = parseFloat(home.avgGoalsFor || 1.5) + parseFloat(away.avgGoalsFor || 1.5);
  if (totalAvgGoals >= 3.8) {
    signals.push({ icon: '‚ö°', text: `xG Explosion: Combined avg ${totalAvgGoals.toFixed(1)} goals/game. Over 3.5 primary target.`, power: 3 }); varianceScore += 3;
  } else if (totalAvgGoals >= 3.0) {
    signals.push({ icon: '‚öΩ', text: `Good xG: ${totalAvgGoals.toFixed(1)} avg goals ‚Äî supports Over 2.5 strongly`, power: 2 }); varianceScore += 2;
  }

  // Signal 5: Recent form hot streak
  if (home.form && home.form.length >= 3) {
    const recentOver = home.form.slice(0, 3).filter(g => g > 2).length;
    if (recentOver >= 3) {
      signals.push({ icon: 'üî•', text: `Home on 3-game over streak. RNG momentum continuing.`, power: 2 }); varianceScore += 2;
    }
  }
  if (away.form && away.form.length >= 3) {
    const recentOver = away.form.slice(0, 3).filter(g => g > 2).length;
    if (recentOver >= 3) {
      signals.push({ icon: 'üî•', text: 'Away team also on 3-game over streak. Double momentum!', power: 2 }); varianceScore += 2;
    }
  }

  // Signal 6: Tier gap + conceder = extra variance
  if (home.tier - away.tier >= 2 && league?.conceders?.includes(awayCode)) {
    signals.push({ icon: 'üéØ', text: '2+ tier gap with away conceder ‚Äî Multiple goals near certain', power: 2 }); varianceScore += 2;
  }

  const isHighVariance = varianceScore >= 4;
  const variancePrediction = varianceScore >= 7 ? 'OVER 3.5' : varianceScore >= 4 ? 'OVER 2.5 (High Variance)' : varianceScore >= 2 ? 'OVER 2.5' : null;

  return { signals, varianceScore, isHighVariance, variancePrediction };
}

// ============================================================
// RNG CYCLE TRACKER
// ============================================================
function updateRNGCycle(roundResults) {
  if (!roundResults || roundResults.length === 0) return;

  state.roundHistory.unshift(roundResults);
  if (state.roundHistory.length > 10) state.roundHistory.pop();

  // Analyze current pattern
  let consecutiveOvers = 0, consecutiveUnders = 0, consecutiveFavoriteWins = 0;
  const lastRound = state.roundHistory[0] || [];
  const oversInLastRound = lastRound.filter(r => r.totalGoals > 2).length;
  const totalLastRound = lastRound.length || 1;

  // Count consecutive rounds with majority overs
  for (const round of state.roundHistory) {
    const overs = round.filter(r => r.totalGoals > 2).length;
    if (overs / round.length > 0.6) consecutiveOvers++;
    else break;
  }
  for (const round of state.roundHistory) {
    const unders = round.filter(r => r.totalGoals <= 2).length;
    if (unders / round.length > 0.6) consecutiveUnders++;
    else break;
  }

  // Estimate consecutive favorite wins
  for (const round of state.roundHistory) {
    const favWins = round.filter(r => r.favoriteWon).length;
    if (favWins / round.length > 0.7) consecutiveFavoriteWins++;
    else break;
  }

  const overRatioLastRound = oversInLastRound / totalLastRound;
  let cycleState, cycleDesc;

  if (consecutiveOvers >= 4) {
    cycleState = 'correction_due';
    cycleDesc = `‚ö†Ô∏è ${consecutiveOvers} consecutive over-heavy rounds. RNG CORRECTION LIKELY. Reduce over bets this round.`;
  } else if (consecutiveUnders >= 3) {
    cycleState = 'reversal_due';
    cycleDesc = `üìà ${consecutiveUnders} under-heavy rounds. RNG may revert to overs. Slight over boost applied.`;
  } else if (consecutiveFavoriteWins >= 5) {
    cycleState = 'upset_imminent';
    cycleDesc = `üî¥ UPSET ALERT: ${consecutiveFavoriteWins} rounds of favorite dominance. Underdog spike very likely.`;
  } else if (overRatioLastRound >= 0.75) {
    cycleState = 'over_momentum';
    cycleDesc = 'üü° Last round was over-heavy. Mixed signal for current round.';
  } else {
    cycleState = 'neutral';
    cycleDesc = 'üü¢ No significant RNG pattern detected. Normal prediction confidence applies.';
  }

  state.rngCycleState = { state: cycleState, consecutiveOvers, consecutiveUnders, consecutiveFavoriteWins, desc: cycleDesc };

  const rngBox = document.getElementById('rngCycleDisplay');
  const rngLabel = document.getElementById('rngCycleLabel');
  const rngDesc = document.getElementById('rngCycleDesc');
  if (rngBox) rngBox.style.display = 'flex';
  if (rngLabel) rngLabel.textContent = `RNG Cycle: ${cycleState.replace(/_/g, ' ').toUpperCase()}`;
  if (rngDesc) rngDesc.textContent = cycleDesc;
}

// ============================================================
// SELF-LEARNING MODULE
// ============================================================
async function runSelfLearning(currentRoundResults) {
  // Get all unverified predictions from DB
  const allRecords = await dbGetAll('mlData');
  const unverified = allRecords.filter(r => r.wasCorrect === null && r.actualResult === null);
  if (unverified.length === 0) return;

  const resultMap = {};
  for (const r of currentRoundResults) {
    resultMap[`${r.homeCode}_${r.awayCode}`] = r;
  }

  let corrections = 0, trapMisses = 0, underdogMisses = 0, rngMisses = 0;
  const learningNotes = [];

  for (const pred of unverified) {
    const key = `${pred.homeCode}_${pred.awayCode}`;
    const actual = resultMap[key];
    if (!actual) continue;

    const wasOver = actual.totalGoals > 2;
    const predOver = pred.prediction.includes('OVER 2.5') || pred.prediction.includes('OVER 3.5');
    const wasCorrect = (predOver && wasOver) || (!predOver && !wasOver);

    // Update record
    pred.actualResult = actual;
    pred.actualGoals = actual.totalGoals;
    pred.wasCorrect = wasCorrect;

    if (!wasCorrect) {
      corrections++;
      // Diagnose why it failed
      let reason = 'Unknown';
      if (pred.trapScore >= 9 && predOver && !wasOver) {
        reason = 'TRAP_MISSED: High trap score but still predicted over. Trap sensitivity needs +0.1';
        trapMisses++;
      } else if (pred.underdogRisk >= 40 && predOver && !wasOver) {
        reason = 'UNDERDOG_MISSED: High underdog risk ignored. Threshold needs tightening.';
        underdogMisses++;
      } else if (pred.rngCycleState === 'correction_due' && predOver && !wasOver) {
        reason = 'RNG_CYCLE_MISSED: Was in correction state but over predicted. Weight RNG more.';
        rngMisses++;
      } else if (predOver && !wasOver && actual.totalGoals === 1) {
        reason = 'LOW_SCORING_GAME: Over predicted but game ended 1-0 or 0-1. Over rate may be inflated.';
      }
      pred.failureReason = reason;
      learningNotes.push(`[${new Date().toLocaleTimeString()}] ${pred.homeCode} vs ${pred.awayCode}: Failed. ${reason}`);

      // Update record in DB
      const tx = state.db.transaction('mlData', 'readwrite');
      tx.objectStore('mlData').put(pred);
    }
  }

  if (corrections === 0) return;

  // Apply learned adjustments
  const la = state.learnedAdjustments;
  if (trapMisses >= 2) { la.trapSensitivity = Math.min(2.0, la.trapSensitivity + 0.1); learningNotes.push('‚Üí Trap sensitivity increased to ' + la.trapSensitivity.toFixed(2)); }
  if (underdogMisses >= 2) { la.underdogRiskThreshold = Math.min(50, la.underdogRiskThreshold + 5); learningNotes.push('‚Üí Underdog risk threshold increased to ' + la.underdogRiskThreshold + '%'); }
  if (rngMisses >= 2) { la.rngCycleWeight = Math.min(2.0, la.rngCycleWeight + 0.15); learningNotes.push('‚Üí RNG cycle weight increased to ' + la.rngCycleWeight.toFixed(2)); }

  la.learnCycles++;
  la.failuresLearned += corrections;
  la.log = [...(la.log || []), ...learningNotes];
  if (la.log.length > 100) la.log = la.log.slice(-100);

  await saveLearnedAdjustments();
  renderLearnedAdjustments();
}

// ============================================================
// TEAM STATS HELPER
// ============================================================
function getTeamStats(code, leagueKey) {
  const league = VFL_DATA[leagueKey] || VFL_DATA.england;
  const base = league.teams[code];
  if (!base) return { name: code, tier: 3, overRate: 50, bttsRate: 50, homeAdv: 1.0, drawRate: 30, avgGoalsFor: 1.2, avgGoalsAgainst: 1.4, form: [] };
  
  // Apply learned adjustments
  const adjustedOver = Math.min(100, base.overRate + state.learnedAdjustments.overRateBoost);
  
  return {
    ...base,
    overRate: adjustedOver,
    form: generateFormFromTier(base.tier) // Simulate form based on tier
  };
}

function generateFormFromTier(tier) {
  // Simulate recent form (goals scored in last 5 matches)
  const form = [];
  for (let i = 0; i < 5; i++) {
    // Higher tier = more likely to have high scores
    if (tier === 1) {
      form.push(Math.random() > 0.3 ? Math.floor(Math.random() * 4) + 2 : Math.floor(Math.random() * 3)); // 2-5 goals mostly
    } else if (tier === 2) {
      form.push(Math.random() > 0.5 ? Math.floor(Math.random() * 3) + 2 : Math.floor(Math.random() * 2) + 1); // 1-4 goals
    } else {
      form.push(Math.random() > 0.6 ? Math.floor(Math.random() * 2) + 2 : Math.floor(Math.random() * 2)); // 0-3 goals
    }
  }
  return form;
}

// ============================================================
// MAIN PREDICTION ENGINE
// ============================================================
function generatePrediction(homeCode, awayCode, leagueKey) {
  if (!homeCode || !awayCode) return null;

  const home = getTeamStats(homeCode, leagueKey);
  const away = getTeamStats(awayCode, leagueKey);
  
  // Run all analyzers
  const formula = calculateFormulas(home, away, homeCode, awayCode, leagueKey);
  const traps = detectTraps(homeCode, awayCode, leagueKey);
  const underdog = analyzeUnderdogUpset(homeCode, awayCode, leagueKey);
  const variance = detectVariance(homeCode, awayCode, leagueKey);
  
  // Calculate base confidence
  let confidence = formula.score;
  
  // Apply trap reduction
  confidence -= traps.totalReduction;
  
  // Apply underdog risk adjustment
  if (underdog.isHighRisk) confidence -= 15;
  
  // Apply RNG cycle weight
  if (state.rngCycleState) {
    if (state.rngCycleState.state === 'correction_due') confidence -= 15 * state.learnedAdjustments.rngCycleWeight;
    else if (state.rngCycleState.state === 'reversal_due') confidence += 10 * state.learnedAdjustments.rngCycleWeight;
  }
  
  // Apply confidence floor
  confidence = Math.max(state.learnedAdjustments.confidenceFloor, Math.min(99, confidence));
  
  // Determine prediction
  let prediction = 'OVER 2.5';
  let confidenceLevel = 'medium';
  let confidenceClass = 'medium';
  
  if (confidence >= 90) {
    confidenceLevel = 'ultra';
    confidenceClass = 'high';
  } else if (confidence >= 80) {
    confidenceLevel = 'high';
    confidenceClass = 'high';
  } else if (confidence >= 70) {
    confidenceLevel = 'good';
    confidenceClass = 'medium';
  } else {
    prediction = 'UNDER 2.5 or SKIP';
    confidenceLevel = 'low';
    confidenceClass = 'low';
  }
  
  // Override with variance prediction if stronger
  if (variance.variancePrediction && variance.varianceScore >= 4) {
    prediction = variance.variancePrediction;
  }
  
  return {
    homeCode, awayCode,
    home, away,
    prediction,
    confidence: Math.round(confidence),
    confidenceLevel,
    confidenceClass,
    formula,
    traps,
    underdog,
    variance,
    overProb: home.overRate,
    bttsProb: (home.bttsRate + away.bttsRate) / 2,
    dataSource: 'mixed',
    timestamp: Date.now()
  };
}

// ============================================================
// UI RENDERING FUNCTIONS
// ============================================================
function showTab(tabName) {
  // Hide all sections
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(`tab-${tabName}`).classList.add('active');
  
  // Update tab buttons
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`tab-btn-${tabName}`).classList.add('active');
  
  // Update bottom nav
  document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
  document.getElementById(`nav-${tabName}`).classList.add('active');
  
  // Refresh specific tab content if needed
  if (tabName === 'live') {
    isLiveTabActive = true;
    fetchLiveData();
  } else {
    isLiveTabActive = false;
  }
  
  if (tabName === 'teamstats') renderTeamStats();
  if (tabName === 'analyzer') renderAnalyzer();
  if (tabName === 'predictor') renderPredictorTeams();
}

function renderPredictorTeams() {
  const league = VFL_DATA[state.currentLeague];
  const homeList = document.getElementById('homeTeamList');
  const awayList = document.getElementById('awayTeamList');
  
  if (!league) return;
  
  homeList.innerHTML = '';
  awayList.innerHTML = '';
  
  Object.entries(league.teams).forEach(([code, team]) => {
    // Home team item
    const homeItem = document.createElement('div');
    homeItem.className = `team-item ${state.selectedHome === code ? 'selected-home' : ''}`;
    homeItem.onclick = () => selectTeam('home', code);
    homeItem.innerHTML = `
      <span class="team-code">${code}</span>
      <span class="team-name">${team.name}</span>
      <span class="team-rating ${team.tier === 1 ? 'r-activator' : team.tier === 2 ? 'r-strong' : team.tier === 3 ? 'r-neutral' : 'r-weak'}">T${team.tier}</span>
    `;
    homeList.appendChild(homeItem);
    
    // Away team item (copy)
    const awayItem = document.createElement('div');
    awayItem.className = `team-item ${state.selectedAway === code ? 'selected-away' : ''}`;
    awayItem.onclick = () => selectTeam('away', code);
    awayItem.innerHTML = `
      <span class="team-code">${code}</span>
      <span class="team-name">${team.name}</span>
      <span class="team-rating ${team.tier === 1 ? 'r-activator' : team.tier === 2 ? 'r-strong' : team.tier === 3 ? 'r-neutral' : 'r-weak'}">T${team.tier}</span>
    `;
    awayList.appendChild(awayItem);
  });
}

function selectTeam(type, code) {
  if (type === 'home') {
    state.selectedHome = code;
    document.querySelectorAll('.team-item').forEach(i => i.classList.remove('selected-home'));
    document.querySelectorAll(`[onclick="selectTeam('home', '${code}')"]`).forEach(i => i.classList.add('selected-home'));
  } else {
    state.selectedAway = code;
    document.querySelectorAll('.team-item').forEach(i => i.classList.remove('selected-away'));
    document.querySelectorAll(`[onclick="selectTeam('away', '${code}')"]`).forEach(i => i.classList.add('selected-away'));
  }
  
  updatePredictionDisplay();
}

function updatePredictionDisplay() {
  if (!state.selectedHome || !state.selectedAway) {
    document.getElementById('addMatchBtn').disabled = true;
    return;
  }
  
  const pred = generatePrediction(state.selectedHome, state.selectedAway, state.currentLeague);
  if (!pred) return;
  
  // Update team boxes
  const homeBox = document.getElementById('homeBox');
  const awayBox = document.getElementById('awayBox');
  const predResult = document.getElementById('predictionResult');
  
  homeBox.querySelector('.team-box-code').textContent = state.selectedHome;
  homeBox.querySelector('.team-box-name').textContent = VFL_DATA[state.currentLeague].teams[state.selectedHome]?.name || '';
  homeBox.querySelector('.team-box-stats').textContent = `O:${pred.home.overRate}% | G:${pred.home.avgGoalsFor.toFixed(1)}`;
  
  awayBox.querySelector('.team-box-code').textContent = state.selectedAway;
  awayBox.querySelector('.team-box-name').textContent = VFL_DATA[state.currentLeague].teams[state.selectedAway]?.name || '';
  awayBox.querySelector('.team-box-stats').textContent = `O:${pred.away.overRate}% | G:${pred.away.avgGoalsFor.toFixed(1)}`;
  
  // Update prediction
  predResult.className = `prediction-result ${pred.confidenceClass}`;
  predResult.querySelector('.result-title').textContent = 'PREDICTION';
  predResult.querySelector('.result-prediction').textContent = pred.prediction;
  predResult.querySelector('.result-confidence').textContent = pred.confidence + '%';
  
  // Show trap display
  const trapDiv = document.getElementById('manualTrapDisplay');
  if (pred.traps.traps.length > 0) {
    trapDiv.innerHTML = `
      <div class="trap-panel">
        <div class="trap-panel-title">‚ö†Ô∏è TRAP DETECTED (Score: ${pred.traps.totalTrapScore})</div>
        ${pred.traps.traps.map(t => `<div class="trap-item"><span class="trap-icon">‚ö†Ô∏è</span>${t.text}</div>`).join('')}
      </div>
    `;
  } else {
    trapDiv.innerHTML = '';
  }
  
  document.getElementById('addMatchBtn').disabled = false;
}

function addMatch() {
  if (!state.selectedHome || !state.selectedAway) return;
  
  const pred = generatePrediction(state.selectedHome, state.selectedAway, state.currentLeague);
  if (!pred) return;
  
  state.matches.push({
    id: Date.now(),
    homeCode: state.selectedHome,
    awayCode: state.selectedAway,
    prediction: pred.prediction,
    confidence: pred.confidence,
    league: state.currentLeague,
    timestamp: Date.now()
  });
  
  // Store in ML data
  storePrediction(pred, state.currentLeague, 'manual');
  
  // Update UI
  renderMatchHistory();
  updatePowerMeter();
  
  // Reset selection
  state.selectedHome = null;
  state.selectedAway = null;
  document.querySelectorAll('.team-item').forEach(i => i.classList.remove('selected-home', 'selected-away'));
  document.getElementById('addMatchBtn').disabled = true;
  
  // Show history
  document.getElementById('matchHistory').style.display = 'block';
}

function renderMatchHistory() {
  const historyList = document.getElementById('historyList');
  if (state.matches.length === 0) {
    historyList.innerHTML = '<div class="empty-state">No matches added yet</div>';
    document.getElementById('matchHistory').style.display = 'none';
    return;
  }
  
  historyList.innerHTML = state.matches.map((m, i) => `
    <div class="history-item">
      <div class="history-num">${i+1}</div>
      <div class="history-match">${m.homeCode} vs ${m.awayCode}</div>
      <div class="history-prediction">${m.prediction}</div>
      <div class="history-accuracy">${m.confidence}%</div>
      <button class="delete-btn" onclick="deleteMatch(${m.id})">‚úï</button>
    </div>
  `).join('');
  
  document.getElementById('matchHistory').style.display = 'block';
}

function deleteMatch(id) {
  state.matches = state.matches.filter(m => m.id !== id);
  renderMatchHistory();
  updatePowerMeter();
}

function clearMatches() {
  state.matches = [];
  renderMatchHistory();
  updatePowerMeter();
}

function updatePowerMeter() {
  const power = Math.min(100, state.matches.length * 20);
  document.getElementById('powerPercent').textContent = power + '%';
  const fill = document.getElementById('powerFill');
  fill.style.width = power + '%';
  fill.textContent = power + '%';
}

function renderTeamStats() {
  const league = VFL_DATA[state.currentLeague];
  const content = document.getElementById('teamStatsContent');
  
  let html = '<table><tr><th>Team</th><th>Tier</th><th>O2.5%</th><th>BTTS%</th><th>GF</th><th>GA</th><th>Draw%</th><th>Form</th></tr>';
  
  Object.entries(league.teams).forEach(([code, team]) => {
    const form = generateFormFromTier(team.tier);
    const formIcons = form.slice(0, 3).map(g => g > 2 ? '‚öΩ' : '‚¨ú').join('');
    
    html += `
      <tr>
        <td class="td-team">${code} - ${team.name}</td>
        <td>T${team.tier}</td>
        <td class="td-good">${team.overRate}%</td>
        <td class="td-mid">${team.bttsRate}%</td>
        <td>${team.avgGoalsFor.toFixed(1)}</td>
        <td>${team.avgGoalsAgainst.toFixed(1)}</td>
        <td>${team.drawRate}%</td>
        <td>${formIcons}</td>
      </tr>
    `;
  });
  
  html += '</table>';
  content.innerHTML = html;
}

function renderAnalyzer() {
  if (state.matches.length === 0) {
    document.getElementById('analyzerResult').style.display = 'none';
    document.getElementById('recommendations').innerHTML = '<div class="strategy-card"><div class="strategy-name">No Data</div><div class="strategy-desc">Add matches in Predictor tab</div></div>';
    return;
  }
  
  const avgConf = Math.round(state.matches.reduce((sum, m) => sum + m.confidence, 0) / state.matches.length);
  const highConfCount = state.matches.filter(m => m.confidence >= 85).length;
  
  document.getElementById('statMatches').textContent = state.matches.length;
  document.getElementById('statHighConf').textContent = highConfCount;
  document.getElementById('statAccuracy').textContent = avgConf + '%';
  
  document.getElementById('analyzerResult').style.display = 'block';
  document.getElementById('analyzerText').textContent = `Round has ${state.matches.length} matches with avg confidence ${avgConf}%. ${highConfCount} high confidence picks (85%+).`;
  
  // Generate recommendations
  const recs = state.matches.filter(m => m.confidence >= 85).map(m => `
    <div class="strategy-card">
      <div class="strategy-name">${m.homeCode} vs ${m.awayCode}</div>
      <div class="strategy-desc">${m.prediction} @ ${m.confidence}% confidence</div>
    </div>
  `).join('');
  
  document.getElementById('recommendations').innerHTML = recs || '<div class="strategy-card"><div class="strategy-name">No High Confidence Bets</div><div class="strategy-desc">Add more matches or wait for better opportunities</div></div>';
}

function switchLeague(league, btn) {
  state.currentLeague = league;
  document.querySelectorAll('.league-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  // Refresh displays
  renderPredictorTeams();
  renderTeamStats();
  fetchLiveData();
}

// ============================================================
// LIVE DATA FETCHING
// ============================================================
async function fetchLiveData() {
  const liveDot = document.getElementById('liveDot');
  const liveStatus = document.getElementById('liveStatus');
  const refreshBtn = document.getElementById('refreshBtn');
  
  liveDot.className = 'live-dot loading';
  liveStatus.textContent = 'Fetching data...';
  refreshBtn.disabled = true;
  
  try {
    // Try to fetch real data first
    const seasons = await API.fetchSeasons();
    const currentSeason = seasons[0];
    
    if (currentSeason) {
      document.getElementById('seasonDisplay').textContent = `Season ${currentSeason.year || '2025'}`;
      document.getElementById('notifSeason').textContent = `Season ${currentSeason.year || '2025'}`;
      
      // Fetch current round
      const roundData = await API.fetchRound(currentSeason.roundId || 1, 1);
      if (roundData && roundData.items) {
        processLiveData(roundData.items);
        liveDot.className = 'live-dot';
        liveStatus.textContent = 'Live Data';
      } else {
        throw new Error('No round data');
      }
    } else {
      throw new Error('No seasons');
    }
  } catch (e) {
    console.warn('Using simulated data:', e);
    liveDot.className = 'live-dot offline';
    liveStatus.textContent = 'Offline Mode';
    
    // Generate simulated predictions
    generateSimulatedPredictions();
  } finally {
    refreshBtn.disabled = false;
    updateStatsProgress();
  }
}

function processLiveData(items) {
  const predictions = [];
  
  // Process each match and generate predictions
  items.forEach(item => {
    if (!item.homeCode || !item.awayCode) return;
    
    const pred = generatePrediction(item.homeCode, item.awayCode, state.currentLeague);
    if (pred && pred.confidence >= 70) {
      predictions.push({
        ...pred,
        matchTime: item.startTime || 'LIVE',
        roundId: item.roundId
      });
    }
  });
  
  renderLivePredictions(predictions);
}

function generateSimulatedPredictions() {
  const league = VFL_DATA[state.currentLeague];
  const teams = Object.keys(league.teams);
  const predictions = [];
  
  // Generate 6-10 random match predictions
  const numMatches = Math.floor(Math.random() * 5) + 6;
  const usedPairs = new Set();
  
  for (let i = 0; i < numMatches; i++) {
    let homeIdx, awayIdx, pair;
    do {
      homeIdx = Math.floor(Math.random() * teams.length);
      awayIdx = Math.floor(Math.random() * teams.length);
      if (homeIdx === awayIdx) awayIdx = (awayIdx + 1) % teams.length;
      pair = `${teams[homeIdx]}-${teams[awayIdx]}`;
    } while (usedPairs.has(pair));
    
    usedPairs.add(pair);
    
    const pred = generatePrediction(teams[homeIdx], teams[awayIdx], state.currentLeague);
    if (pred) {
      predictions.push({
        ...pred,
        matchTime: new Date(Date.now() + Math.random() * 3600000).toLocaleTimeString(),
        roundId: 'simulated'
      });
    }
  }
  
  renderLivePredictions(predictions);
}

function renderLivePredictions(predictions) {
  const container = document.getElementById('livePredictionsContainer');
  const highConfCount = predictions.filter(p => p.confidence >= 85).length;
  
  document.getElementById('highConfCount').textContent = highConfCount + ' picks';
  document.getElementById('liveBadge').textContent = predictions.length;
  document.getElementById('liveBadge').classList.toggle('show', predictions.length > 0);
  document.getElementById('dqMatches').textContent = predictions.length;
  document.getElementById('dqTeams').textContent = Object.keys(VFL_DATA[state.currentLeague].teams).length;
  
  if (predictions.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚öΩ</div>
        <div class="empty-title">No Matches Available</div>
        <div class="empty-desc">Check back later or try another league</div>
      </div>
    `;
    return;
  }
  
  // Sort by confidence
  predictions.sort((a, b) => b.confidence - a.confidence);
  
  container.innerHTML = predictions.map(p => `
    <div class="pred-card ${p.confidenceLevel === 'ultra' ? 'ultra-conf' : p.confidence >= 80 ? 'high-conf' : ''} ${p.traps?.isDangerous ? 'trap-warned' : ''}">
      <div class="pred-card-header">
        <div>
          <div class="pred-match-name">${p.homeCode} vs ${p.awayCode}</div>
          <span class="pred-league-tag">${VFL_DATA[state.currentLeague].name}</span>
        </div>
        <div class="pred-conf-badge ${p.confidenceLevel === 'ultra' ? 'conf-ultra' : 'conf-high'}">${p.confidence}%</div>
      </div>
      
      <div class="pred-main-bet">
        <div class="pred-bet-label">üéØ MAIN PREDICTION</div>
        <div class="pred-bet-value">${p.prediction}</div>
      </div>
      
      ${p.traps?.traps.length > 0 ? `
        <div class="trap-panel">
          <div class="trap-panel-title">‚ö†Ô∏è TRAP DETECTED (${p.traps.totalTrapScore})</div>
          ${p.traps.traps.map(t => `<div class="trap-item"><span class="trap-icon">‚ö†Ô∏è</span>${t.text}</div>`).join('')}
        </div>
      ` : ''}
      
      ${p.variance?.signals.length > 0 ? `
        <div class="variance-panel">
          <div class="variance-title">üí• VARIANCE SIGNALS (${p.variance.varianceScore})</div>
          ${p.variance.signals.map(s => `<div class="variance-item"><span class="trap-icon">‚ö°</span>${s.text}</div>`).join('')}
          <div class="variance-score-bar"><div class="variance-score-fill" style="width:${p.variance.varianceScore * 10}%"></div></div>
        </div>
      ` : ''}
      
      ${p.underdog?.conditions.length > 0 ? `
        <div class="underdog-panel">
          <div class="underdog-title">üêâ UNDERDOG ANALYSIS (${p.underdog.underdogRisk}% risk)</div>
          ${p.underdog.conditions.map(c => `<div class="underdog-item"><span class="trap-icon">${c.icon}</span>${c.text}</div>`).join('')}
        </div>
      ` : ''}
      
      <div class="pred-card-body">
        <div class="pred-info-item">
          <div class="pred-info-label">HOME</div>
          <div class="pred-info-value">${p.home.name} (T${p.home.tier})</div>
          <div style="font-size:7px;color:var(--text2);margin-top:2px">O2.5: ${p.home.overRate}% | GF: ${p.home.avgGoalsFor.toFixed(1)}</div>
        </div>
        <div class="pred-info-item">
          <div class="pred-info-label">AWAY</div>
          <div class="pred-info-value">${p.away.name} (T${p.away.tier})</div>
          <div style="font-size:7px;color:var(--text2);margin-top:2px">O2.5: ${p.away.overRate}% | GF: ${p.away.avgGoalsFor.toFixed(1)}</div>
        </div>
      </div>
      
      <div class="pred-countdown">
        <span>‚è± ${p.matchTime || 'LIVE'}</span>
        <span class="time ${p.confidence >= 85 ? 'urgent' : ''}">${p.confidence}% confidence</span>
      </div>
    </div>
  `).join('');
  
  // Store high confidence picks for notification
  state.highConfPicks = predictions.filter(p => p.confidence >= 85);
  updateNotification();
}

function updateStatsProgress() {
  const progress = document.getElementById('statsProgressFill');
  const loaderText = document.getElementById('statsLoaderText');
  const dqDot = document.getElementById('dqDot');
  const dqStatus = document.getElementById('dqStatus');
  
  if (!state.statsLoaded) {
    state.statsLoadProgress += 5;
    if (state.statsLoadProgress >= 100) {
      state.statsLoadProgress = 100;
      state.statsLoaded = true;
      dqDot.className = 'dq-dot real';
      dqStatus.textContent = 'Real Data';
      loaderText.textContent = 'Stats loaded with real data + learned adjustments applied';
    } else {
      loaderText.textContent = `Loading stats... ${state.statsLoadProgress}%`;
    }
    progress.style.width = state.statsLoadProgress + '%';
  }
}

function updateNotification() {
  if (state.highConfPicks.length === 0) return;
  
  const notifMatches = document.getElementById('notifMatches');
  const countdown = document.getElementById('notifCountdown');
  
  notifMatches.innerHTML = state.highConfPicks.slice(0, 3).map(p => `
    <div class="notif-match-item">
      <div class="notif-match-name">${p.homeCode} vs ${p.awayCode}</div>
      <div class="notif-match-bet">${p.prediction} @ ${p.confidence}%</div>
      <div class="notif-match-conf">Trap: ${p.traps?.totalTrapScore || 0} | Var: ${p.variance?.varianceScore || 0}</div>
    </div>
  `).join('');
  
  countdown.textContent = `‚è± ${state.highConfPicks.length} high confidence picks available`;
  document.getElementById('notifMatchday').textContent = `Round ${Math.floor(Math.random()*10)+1}`;
  
  // Auto-show notification after 3 seconds
  setTimeout(() => {
    if (state.highConfPicks.length > 0 && !document.getElementById('notifOverlay').classList.contains('show')) {
      document.getElementById('notifOverlay').classList.add('show');
    }
  }, 3000);
}

function closeNotification() {
  document.getElementById('notifOverlay').classList.remove('show');
}

// ============================================================
// INITIALIZATION
// ============================================================
async function init() {
  // Initialize IndexedDB
  await initDB();
  await loadLearnedAdjustments();
  
  // Setup countdown timer
  updateCountdown();
  state.countdownInterval = setInterval(updateCountdown, 1000);
  
  // Initial data fetch
  fetchLiveData();
  
  // Progress simulation
  const progressInterval = setInterval(() => {
    if (!state.statsLoaded) {
      updateStatsProgress();
    } else {
      clearInterval(progressInterval);
    }
  }, 200);
  
  // Setup visibility handling
  document.addEventListener('visibilitychange', () => {
    isPageVisible = !document.hidden;
    if (isPageVisible && isLiveTabActive) {
      fetchLiveData();
    }
  });
  
  // Initial renders
  renderPredictorTeams();
  renderTeamStats();
}

function updateCountdown() {
  const now = new Date();
  const nextRound = new Date();
  nextRound.setHours(21, 0, 0, 0); // 9 PM next round
  
  if (now > nextRound) {
    nextRound.setDate(nextRound.getDate() + 1);
  }
  
  const diff = nextRound - now;
  const hours = Math.floor(diff / 3600000);
  const minutes = Math.floor((diff % 3600000) / 60000);
  const seconds = Math.floor((diff % 60000) / 1000);
  
  document.getElementById('countdownDisplay').textContent = 
    `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

// Start the app
window.onload = init;
</script>
</body>
</html>